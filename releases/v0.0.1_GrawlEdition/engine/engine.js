(()=>{"use strict";var t={d:(e,s)=>{for(var i in s)t.o(s,i)&&!t.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:s[i]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{API:()=>j,ActionGame:()=>O,Animation:()=>X,CaptureProperties:()=>u.CaptureProperties,CollideLayers:()=>o,CollideTypes:()=>a,Engine:()=>N,Fauna:()=>I,Frame:()=>G,Level:()=>P,Player:()=>z,Rectangle:()=>Y});var s,i,r,a,o,h,n,l,c,p,d,u={};t.r(u),t.d(u,{R:()=>U}),function(t){class e{static lastTick=0;static currTick=0}class s{static firstTick=0;static delta=16;static refresh(){e.currTick=Date.now(),s.delta=Math.min(e.currTick-e.lastTick,100),e.lastTick=e.currTick}static getTick(){return e.currTick}}t.Delta=s,t.Timeout=class{ms;step=0;end;start;deletion=!1;paused=!1;done=!1;continuous=!1;repeat=!0;pauseTime=0;actions={};trigName;constructor(t,s,i={continuous:!1,repeat:!0},r={}){this.ms=t,this.trigName=s,i.continuous?this.continuous=i.continuous:this.continuous=!1,i.repeat?this.repeat=i.repeat:this.repeat=!0,this.start=e.currTick,t[0]===1/0?this.end=1/0:this.end=e.currTick+t[0],this.actions=r}reset(){this.start=e.currTick,this.ms[this.step]===1/0?this.end=1/0:this.end=e.currTick+this.ms[this.step]}restart(){this.paused=!1,this.step=0,this.reset()}pause(){this.pauseTime=e.currTick,this.paused=!0}resume(){this.start+=e.currTick-this.pauseTime,this.end===1/0||(this.end+=e.currTick-this.pauseTime),this.pauseTime=0,this.paused=!1}getTimeoutTicks(){return(this.paused?this.pauseTime:e.currTick)-this.start}test(){if(this.done)return{name:this.trigName,state:"done"};if(!this.paused){if(this.end<=e.currTick)return this.continuous?this.step++:this.repeat||(this.done=!0),this.step>=this.ms.length&&(this.step=0,this.repeat||(this.done=!0)),this.start=e.currTick,this.ms[this.step]!==1/0?this.end=e.currTick+this.ms[this.step]:this.end=1/0,this.actions.triggered&&this.actions.triggered(this),{name:this.trigName,state:"triggered"};if(!this.actions.active)return{name:this.trigName,state:"active"};this.actions.active(this)}return this.end===1/0||(this.end+=s.delta),{name:this.trigName,state:"paused"}}}}(s||(s={})),function(t){class e{static MAXLAYERS=256;static textcanvas=(()=>{let t=document.createElement("canvas");return t.width=2048,t.height=2048,t})();static textcontext=e.textcanvas.getContext("2d");static contextCounter=-1}t.Info=e,t.GLContext=class extends e{vbuffer;Rframebuffer;framebuffer;renderbuffer;gl;id;textures;constructor(t,s,i){super(),e.contextCounter++;let r=(()=>{t.setAttribute("width",s),t.setAttribute("height",i),t.style.width=s+"px",t.style.height=i+"px";let e=t.getContext("webgl2",{premultipliedAlpha:!1,antialias:!1});return e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),e})();this.framebuffer=r.createFramebuffer(),this.Rframebuffer=r.createFramebuffer(),this.renderbuffer=r.createRenderbuffer(),this.vbuffer=r.createBuffer(),this.gl=r,this.id=String(e.contextCounter),this.textures={},this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vbuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([1,0,0,0,0,1,1,0,0,1,1,1]),this.gl.STATIC_DRAW),this.gl.clearColor(0,.5,0,0),this.gl.bindFramebuffer(this.gl.READ_FRAMEBUFFER,this.Rframebuffer),this.gl.bindFramebuffer(this.gl.DRAW_FRAMEBUFFER,this.framebuffer),this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,this.renderbuffer),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,this.gl.RGBA8,2e3,2e3),this.gl.framebufferRenderbuffer(this.gl.DRAW_FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.RENDERBUFFER,this.renderbuffer),this.gl.readBuffer(this.gl.COLOR_ATTACHMENT0),this.gl.drawBuffers([this.gl.COLOR_ATTACHMENT0])}addTexture(t,e){this.textures[t]=e}getTexture(t){return this.textures[t]}}}(i||(i={}));class x extends i.Info{static createTexture(t,e){let s=t.gl,i=x.createTexToBlitOn(t,e.width,e.height);return s.bindTexture(s.TEXTURE_2D,i),s.texImage2D(s.TEXTURE_2D,0,s.RGBA,s.RGBA,s.UNSIGNED_BYTE,e),i}static createSprite(t,e,s,i){let r=t.gl;const a=r.createFramebuffer();let o=x.createTexToBlitOn(t,i.w,i.h);return r.bindFramebuffer(r.FRAMEBUFFER,a),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,s,0),r.bindTexture(r.TEXTURE_2D,o),r.copyTexSubImage2D(r.TEXTURE_2D,0,0,0,i.x,i.y,i.w,i.h),r.deleteFramebuffer(a),o}static createTexToBlitOn(t,e,s){let i=t.gl;const r=i.createTexture();return i.bindTexture(i.TEXTURE_2D,r),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,e,s,0,i.RGBA,i.UNSIGNED_BYTE,null),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),r}static nextPowerOfTwo(t){return 2==t||4==t||8==t||16==t||32==t||64==t||128==t||256==t||512==t||1024==t||2048==t?t:t>2048?2048:t<=0?1:(t--,t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,1+(t|=t>>16))}}class m{static pathprefix="";static parser=new DOMParser;static textures={};static texts={};static sounds={};static imgExts=["png","jpg","gif","jpeg"];static txtExts=["nw","txt","vert","frag","gani","csv"];static sndExts=["wav","mp3"];static audioContext;static placeholder="_assets/blocking.png";static setprefix(t){this.pathprefix=t}static getTexture(t){return m.textures[this.pathprefix+t]?m.textures[this.pathprefix+t]:(console.log("Texture file not found or not loaded : "+this.pathprefix+t),m.textures[this.placeholder])}static getTextureWidth(t){return m.textures[this.pathprefix+t]?m.textures[this.pathprefix+t].width:(console.log("Texture file not found or not loaded : "+this.pathprefix+t),-1)}static getTextureHeight(t){return m.textures[this.pathprefix+t]?m.textures[this.pathprefix+t].height:(console.log("Texture file not found or not loaded : "+this.pathprefix+t),-1)}static getText(t){return m.texts[this.pathprefix+t]?m.texts[this.pathprefix+t]:(console.log("Text file not found or not loaded : "+this.pathprefix+t),"")}static initAudio(){m.audioContext=new window.AudioContext}static retrieveTex(t,e){return e.textures[t]||(e.textures[t]=x.createTexture(e,m.getTexture(t))),e.textures[t]}static async addImage(t){if(!m.textures[this.pathprefix+t]){let e=new Image;e.src=this.pathprefix+t;try{await e.decode().then(()=>{m.textures[this.pathprefix+t]=e})}catch{console.error("Image not found: "+this.pathprefix+t)}}return this.pathprefix+t}static async addText(t){if(!m.texts[this.pathprefix+t]){let e=await fetch(this.pathprefix+t).then(t=>t.text()).catch(t=>(console.error("Error loading text file: ",t),"Error loading text file: "+t));m.texts[this.pathprefix+t]=e}return this.pathprefix+t}static async addSound(t){return m.sounds[this.pathprefix+t]||await fetch(this.pathprefix+t).then(t=>t.arrayBuffer()).then(t=>m.audioContext.decodeAudioData(t)).then(e=>{m.sounds[this.pathprefix+t]=e}).catch(t=>console.error("Error loading audio file:",t)),this.pathprefix+t}static playSound(t){m.sounds[this.pathprefix+t]?m.play(m.sounds[this.pathprefix+t]):m.addSound(this.pathprefix+t).then(e=>m.play(m.sounds[this.pathprefix+t])).catch(t=>console.error("Error loading audio file:",t))}static play(t){let e=m.audioContext.createBufferSource();e.buffer=t,e.connect(m.audioContext.destination),e.start()}static async loadAllExtInFolder(t,e){let s=new XMLHttpRequest,i=[];return s.open("GET",t,!1),s.onreadystatechange=function(){if(4===s.readyState&&200===s.status){let r=m.parser.parseFromString(s.responseText,"text/html").getElementsByTagName("a"),a=[];for(let t=0;t<r.length;t++)a.push(r[t].getAttribute("href"));for(let s of a){if(s.trim().length<=0)continue;let r=s.split("."),a=r[r.length-1];a.endsWith("/")||a.startsWith("?")||(e.includes(a)?m.imgExts.includes(a)?i.push(m.addImage(t+s)):m.txtExts.includes(a)?i.push(m.addText(t+s)):m.sndExts.includes(a)?i.push(m.addSound(t+s)):console.log("Incompatible file : "+s):console.log("File is neither "+e.join(" or ")+" : "+s))}}},s.send(),await Promise.all(i),i}}!function(t){class e extends i.Info{rprops;texture;file;ready;parent=void 0;glContext;shadercontext;offset={x:0,y:0};constructor(t,e){super(),this.glContext=t,this.shadercontext=e,this.rprops={srcrect:void 0,dstrect:{x:0,y:0,w:0,h:0},rotcenter:{x:0,y:0},scalecenter:{x:0,y:0},pos:{x:0,y:0},flip:{flipx:!1,flipy:!1},angle:0,scale:{x:1,y:1},layer:0,hidden:!1,delete:!1}}getclientbounds(){return{x:this.getclientleft(),y:this.getclienttop(),w:this.getclientwidth(),h:this.getclientheight()}}getclientleft(){return this.parent?(this.rprops.pos.x+this.parent.getclientleft())*this.getwidthratio():this.rprops.pos.x*this.getwidthratio()}getclienttop(){return(this.rprops.pos.y+(null==this.parent?0:this.parent.getclienttop()))*this.getwidthratio()}getclientwidth(t=this.rprops.dstrect){return t.w*this.getwidthratio()}getclientheight(t=this.rprops.dstrect){return t.h*this.getheightratio()}getwidthratio(){return null!=this.parent?this.rprops.dstrect.w/this.rprops.srcrect.w*this.parent.getwidthratio():this.rprops.dstrect.w/this.rprops.srcrect.w}getheightratio(){return null!=this.parent?this.rprops.dstrect.h/this.rprops.srcrect.h*this.parent.getheightratio():this.rprops.dstrect.h/this.rprops.srcrect.h}retrieveTexture(t){return this.glContext.textures[t]||(this.glContext.textures[t]=x.createTexture(this.glContext,m.getTexture(t))),this.glContext.textures[t]}}t.Renderable=e;class r extends e{text;properties={};size={w:0,h:0};constructor(t,e,s,i={}){super(t,e),this.text=s,this.setProperties(i),r.textcontext.textAlign="left",r.textcontext.textBaseline="top",r.textcontext.font=this.properties.size+"px "+this.properties.font,this.size.w=r.textcontext.measureText(this.text).width}compose(){if(!this.ready){let t=r.textcontext;t.clearRect(0,0,t.canvas.width,t.canvas.height),t.fillStyle="rgba("+this.properties.color.r+","+this.properties.color.g+","+this.properties.color.b+","+this.properties.color.a+")",t.textAlign="left",t.textBaseline="top",t.font=this.properties.size+"px "+this.properties.font,this.rprops.dstrect.w=t.measureText(this.text).width,this.rprops.dstrect.h=this.properties.size,this.size.w=this.rprops.dstrect.w,this.size.h=this.rprops.dstrect.h,t.fillText(this.text,0,0);let e=this.glContext.gl,s=x.createTexToBlitOn(this.glContext,r.textcanvas.width,r.textcanvas.height);e.bindFramebuffer(e.FRAMEBUFFER,this.glContext.framebuffer),e.bindTexture(e.TEXTURE_2D,s),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.size.w,this.size.h,0,e.RGBA,e.UNSIGNED_BYTE,r.textcanvas),this.texture=s,this.ready=!0}return this.rprops.delete&&this.glContext.gl.deleteTexture(this.texture),this.rprops.delete}setText(t){this.ready&&this.glContext.gl.deleteTexture(this.texture),this.text=t,this.size.w=r.textcontext.measureText(this.text).width,this.ready=!1}setProperties(t){this.ready&&this.glContext.gl.deleteTexture(this.texture),this.ready=!1,null!=t.size?this.properties.size=t.size:null==this.properties.size&&(this.properties.size=60),this.size.h=this.properties.size,null!=t.color?this.properties.color=t.color:null==this.properties.color&&(this.properties.color={r:0,g:0,b:0,a:255}),null!=t.font?this.properties.font=t.font:null==this.properties.font&&(this.properties.font="monospace")}setColor(t){this.ready&&this.glContext.gl.deleteTexture(this.texture),this.properties.color=t,this.ready=!1}setSize(t){this.ready&&this.glContext.gl.deleteTexture(this.texture),this.properties.size=t,this.size.h=this.properties.size,this.ready=!1}}t.Text=r,t.Rectangle=class extends e{constructor(t,e,s,i){super(t,e),this.rprops.dstrect=s,this.rprops.colorize=i}compose(){if(!this.ready){let t=this.glContext.gl,e=x.createTexToBlitOn(this.glContext,1,1);t.bindFramebuffer(t.FRAMEBUFFER,this.glContext.framebuffer),t.bindTexture(t.TEXTURE_2D,e),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,new Uint8Array([this.rprops.colorize.r,this.rprops.colorize.g,this.rprops.colorize.b,this.rprops.colorize.a])),this.texture=e,this.ready=!0}return this.rprops.delete&&this.glContext.gl.deleteTexture(this.texture),this.rprops.delete}};class a extends e{constructor(t,e,s,i,r,a=void 0){super(t,e),this.file=s,this.rprops.srcrect=i,this.rprops.dstrect=r}compose(){if(!this.ready){let t=this.glContext.gl,e=x.createTexToBlitOn(this.glContext,this.rprops.srcrect.w,this.rprops.srcrect.h);t.bindFramebuffer(t.FRAMEBUFFER,this.glContext.framebuffer),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.retrieveTexture(this.file),0),t.bindTexture(t.TEXTURE_2D,e),t.copyTexSubImage2D(t.TEXTURE_2D,0,0,0,this.rprops.srcrect.x,this.rprops.srcrect.y,this.rprops.srcrect.w,this.rprops.srcrect.h),t.bindFramebuffer(t.FRAMEBUFFER,null),this.texture=e,this.ready=!0}return this.rprops.delete&&this.texture&&this.glContext.gl.deleteTexture(this.texture),this.rprops.delete}}t.Image=a;class o extends e{remove;dynamic=!1;bg;mask;viewport;applyBg(){}applyMask(){}compose(){return this.rprops.delete}constructor(t,e){super(t,e),this.viewport={x:0,y:0,w:t.gl.canvas.width,h:t.gl.canvas.height}}static createFocus(t){let e=1/0,s=1/0,i=-1/0,r=-1/0;for(const a of t){const t=a.rprops.dstrect.x,h=a.rprops.dstrect.y,n=[{x:0,y:0},{x:a.rprops.dstrect.w,y:0},{x:0,y:a.rprops.dstrect.h},{x:a.rprops.dstrect.w,y:a.rprops.dstrect.h}];for(let l=0;l<n.length;l++){const c=n[l],p=o.scaleThenRotatePreserveOriginalRotation(c,a.rprops.scalecenter||{x:0,y:0},a.rprops.scale||{x:1,y:1},a.rprops.rotcenter||{x:0,y:0},-a.rprops.angle||0),d=t+p.x,u=h+p.y;e=Math.min(e,d),s=Math.min(s,u),i=Math.max(i,d),r=Math.max(r,u)}}return{x:Math.floor(e),y:Math.floor(s),w:Math.ceil(i-Math.floor(e)),h:Math.ceil(r-Math.floor(s))}}generateComposite(t,e){let s=t.filter(t=>!t?.rprops.hidden);if(s.length>0){s.sort((t,e)=>t.rprops.layer-e.rprops.layer);for(let t=0;t<s.length;t++)s[t].compose();this.offset.x=e.x,this.offset.y=e.y,this.rprops.dstrect={x:this.rprops.pos.x+e.x,y:this.rprops.pos.y+e.y,w:e.w,h:e.h};let t=this.glContext.gl;t.bindFramebuffer(t.FRAMEBUFFER,this.glContext.framebuffer),this.texture=x.createTexToBlitOn(this.glContext,e.w,e.h),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.texture,0),t.viewport(0,0,e.w,e.h);for(let i=0;i<s.length;i++){this.glContext.gl.bindTexture(t.TEXTURE_2D,s[i].texture);const r={x:s[i].rprops.dstrect.x-e.x,y:s[i].rprops.dstrect.y-e.y,w:e.w,h:e.h};this.shadercontext.passShader(s[i],r),t.drawArrays(t.TRIANGLES,0,6)}this.ready=!0}else this.ready=!1}getclientleft(){return this.parent?this.rprops.pos.x+this.parent.getclientleft()-this.viewport.x:this.rprops.pos.x-this.viewport.x}getclienttop(){return this.rprops.pos.y+(null==this.parent?0:this.parent.getclienttop())-this.viewport.y}addtocomposition(t){}static rotateAround(t,e,s){const i=Math.cos(s),r=Math.sin(s),a=t.x-e.x,o=t.y-e.y;return{x:e.x+a*i-o*r,y:e.y+a*r+o*i}}static scaleAround(t,e,s){return{x:e.x+(t.x-e.x)*s.x,y:e.y+(t.y-e.y)*s.y}}static scaleThenRotatePreserveOriginalRotation(t,e,s,i,r){const a=o.scaleAround(t,e,s),h={x:e.x+(i.x-e.x)*s.x,y:e.y+(i.y-e.y)*s.y};return o.rotateAround(a,h,r)}}class h extends o{parts;constructor(t,e,s){super(t,e);for(let t of s)t.parent=this;this.parts=s}compose(){if(this.rprops.delete){this.ready&&this.glContext.gl.deleteTexture(this.texture);for(let t of this.parts)t.rprops.delete=!0,t.compose();return this.rprops.delete}if(this.dynamic&&(this.ready&&this.glContext.gl.deleteTexture(this.texture),this.ready=!1),!this.ready){this.parts=this.parts.filter(t=>null!=t&&!t.compose());let t=h.createFocus(this.parts);this.generateComposite(this.parts,t)}return this.rprops.delete}addtocomposition(t){for(let e of t)e.parent=this;this.parts.push(...t)}}t.Snap=h,t.Animation=class extends o{frames;currentFrame=0;timer;constructor(t,e,i,r=[200]){super(t,e),this.dynamic=!0,this.timer=new s.Timeout(r,"framechange"),this.frames=i;for(let t of i)t.parent=this}compose(){if(this.rprops.delete){for(let t of this.frames)t.rprops.delete=!0,t.compose();return this.rprops.delete}return this.handleframechange(),!this.frames[this.currentFrame].dynamic&&this.frames[this.currentFrame].ready||this.frames[this.currentFrame].compose(),this.texture=this.frames[this.currentFrame].texture,this.rprops=this.frames[this.currentFrame].rprops,this.ready=this.frames[this.currentFrame].ready,this.rprops.delete}handleframechange(){"triggered"==this.timer.test().state&&(this.currentFrame+=1,this.currentFrame>=this.frames.length&&(this.currentFrame=0))}pause(){this.timer.pause()}resume(){this.timer.resume()}restart(){this.timer.restart(),this.currentFrame=0}getclientleft(){return this.parent.getclientleft()}getclienttop(){return this.parent.getclienttop()}getclientwidth(){return super.getclientwidth(this.frames[this.currentFrame].rprops.dstrect)}getclientheight(){return super.getclientheight(this.frames[this.currentFrame].rprops.dstrect)}addtocomposition(t){for(let e of t)e.parent=this;this.frames.push(...t)}},t.Frame=class extends o{frame;camera=void 0;picture={crop:{do:!1,w:0,h:0},x:0,y:0,w:0,h:0,img:void 0,ready:!1};constructor(t,e,s,i={w:0,h:0}){super(t,e),this.frame=s,this.dynamic=!0,this.rprops.dstrect.w=i.w,this.rprops.dstrect.h=i.h;for(let t of s)t.parent=this}compose(){if(void 0===this.frame[0])return console.log("Skipping empty frame..."),!0;if((this.dynamic||this.rprops.delete)&&((this.rprops.delete&&this.ready||this.ready)&&this.glContext.gl.deleteTexture(this.texture),this.ready=!1),!this.ready){this.frame=this.frame.filter(t=>null!=t&&!t.compose());let t=this.frame.filter(t=>t.ready),e=h.createFocus(t);this.rprops.dstrect.x=this.rprops.pos.x,this.rprops.dstrect.y=this.rprops.pos.y,void 0!==this.camera&&(this.rprops.dstrect.w=this.camera.viewport.w,this.rprops.dstrect.h=this.camera.viewport.h,this.viewport={x:this.camera.viewport.x,y:this.camera.viewport.y,w:this.camera.viewport.w,h:this.camera.viewport.h}),t.length>0&&this.generateComposite(t,e),this.picture.crop.do&&this.crop(),this.ready=!0}return this.rprops.delete}crop(){if(this.picture.ready&&(this.glContext.gl.deleteTexture(this.glContext.getTexture("croptex")),this.picture.ready=!1),!this.picture.ready){this.glContext.addTexture("croptex",this.texture);let t=new a(this.glContext,this.shadercontext,"croptex",{x:0,y:0,w:this.picture.crop.w,h:this.picture.crop.h},{x:0,y:0,w:this.picture.w,h:this.picture.h});t.compose(),this.texture=t.texture,this.rprops.pos.x=this.picture.x,this.rprops.pos.y=this.picture.y,this.rprops.dstrect.w=this.picture.w,this.rprops.dstrect.h=this.picture.h,this.picture.ready=!0}}setCrop(t,e){this.picture={crop:{do:!0,...t},...e,img:void 0,ready:!1}}addtocomposition(t){for(let e of t)e.parent=this;this.frame.push(...t)}}}(r||(r={})),function(t){t[t.none=1]="none",t[t.block=2]="block",t[t.hurt=4]="hurt",t[t.interact=8]="interact",t[t.climbable=16]="climbable",t[t.water=32]="water",t[t.instakill=64]="instakill",t[t.get=128]="get",t[t.custom0=256]="custom0",t[t.custom1=512]="custom1",t[t.custom2=1024]="custom2",t[t.custom3=2048]="custom3",t[t.custom4=4096]="custom4",t[t.custom5=8192]="custom5",t[t.custom6=16384]="custom6",t[t.custom7=32768]="custom7",t[t.custom8=65536]="custom8",t[t.custom9=131072]="custom9",t[t.all=262143]="all"}(a||(a={})),function(t){t[t.none=1]="none",t[t.player=2]="player",t[t.npc=4]="npc",t[t.grid=8]="grid",t[t.interactable=16]="interactable",t[t.all=31]="all"}(o||(o={})),function(t){class e{lifetime=new s.Timeout([1/0],"lifetime");delete=!1;triggers=[];timeouts=[];gameid;constructor(){}finalize(){}resetmovementvector(){}static refresh(t){let e=t.filter(t=>!t.delete);for(let t=0;t<e.length;t++)e[t].update();for(let t=0;t<e.length;t++)e[t].finalize()}static refreshsome(t){for(let e=0;e<t.length;e++)t[e].update();for(let e=0;e<t.length;e++)t[e].finalize()}static resetallmovements(t){for(let e of t)e.resetmovementvector()}update(){this.timeouts=this.timeouts.filter(t=>!t.deletion&&(this.triggers.push(t.test()),!0))}addTimeout(t,e,i=!0,r=!0){let a=new s.Timeout(t,"noname",{continuous:r,repeat:i},e);return this.timeouts.push(a),a}destroy(){this.delete=!0}react(t,e,s){return!1}}t.Alacrity=e,t.UIElement=class extends e{myAnim;hitbox={x:0,y:0,w:0,h:0};pos={x:0,y:0};hidden=!1;constructor(t){super(),this.myAnim=t;for(let t of this.myAnim.frames)t.rprops.pos=this.pos;this.myAnim.rprops.hidden=this.hidden}};class i extends e{pos={x:0,y:0};hitbox={x:0,y:0,w:0,h:0}}t.Existence=i;class o extends i{myFrame;collisions=[];activeeffects=[1,1,1,1];flip={flipx:!1,flipy:!1};constructor(t){let e;super(),e=t instanceof r.Frame?t:Array.isArray(t)?new r.Frame(t[0].glContext,t[0].shadercontext,t):new r.Frame(t.glContext,t.shadercontext,[t]),this.myFrame=e,this.myFrame.rprops.pos=this.pos,this.myFrame.rprops.layer=.5,this.myFrame.rprops.flip=this.flip}destroy(){this.delete=!0,this.myFrame.rprops.delete=!0;for(let t of this.collisions)t.deleteMe=!0}}t.Embodiment=o,t.Mobility=class extends o{movementvector={x:0,y:0};speed=.2;velocity=new Set;normalgravity={strength:.075,x:0,y:1};destination=null;movetimer=new s.Timeout([1/0],"move");movecallback=()=>{};finalize(){if(null!=this.destination)if(Math.abs(this.pos.x-this.destination.x)<1&&Math.abs(this.pos.y-this.destination.y)<1||"triggered"==this.movetimer.test().state)this.destination=null,this.movecallback();else{let t={x:this.destination.x-this.pos.x,y:this.destination.y-this.pos.y};if(0!=t.x||0!=t.y){let e=Math.sqrt(t.x*t.x+t.y*t.y);e>0&&(this.movementvector.x+=t.x/e,this.movementvector.y+=t.y/e)}}let t={x:this.movementvector.x*this.speed*s.Delta.delta,y:this.movementvector.y*this.speed*s.Delta.delta};for(let e of this.velocity)t.x+=e.x*e.strength*s.Delta.delta,t.y+=e.y*e.strength*s.Delta.delta;(t.x<0&&!(this.activeeffects[1]&a.block)||t.x>0&&!(this.activeeffects[3]&a.block))&&(this.pos.x+=t.x),(t.y<0&&!(this.activeeffects[0]&a.block)||t.y>0&&!(this.activeeffects[2]&a.block))&&(this.pos.y+=t.y)}resetmovementvector(){this.movementvector={x:0,y:0}}movetowards(t,e=1/0,s=()=>{}){this.destination=t,this.movetimer.ms=[e],this.movetimer.restart(),this.movecallback=s}}}(h||(h={})),function(t){t[t.off=0]="off",t[t.disabled=1]="disabled",t[t.enabled=2]="enabled",t[t.running=3]="running",t[t.elapsed=4]="elapsed"}(n||(n={})),function(t){let e;!function(t){t[t.up=0]="up",t[t.left=1]="left",t[t.down=2]="down",t[t.right=3]="right"}(e=t.Dir||(t.Dir={}));class s extends h.Mobility{state="";anims={};dir=2;switchanimation(t,e=-1){let s=-1==e?this.dir:e;this.state!=t?(this.state=t,this.myFrame.frame=[this.anims[this.state][s]],this.anims[this.state][s].restart()):this.myFrame.frame=[this.anims[this.state][s]]}}t.Incarnated=s,t.Fauna=class extends s{update(){super.update();for(let t in this.actions)this.actions[t].state!=n.off&&(this.actions[t].state==n.disabled?(null!=this.actions[t].disabled&&this.actions[t].disabled(),this.actions[t].state=n.off):this.actions[t].state==n.enabled?(null!=this.actions[t].enabled&&this.actions[t].enabled(),null!=this.actions[t].running&&this.actions[t].running(),this.actions[t].state=n.running):"triggered"==this.actions[t].timer?.test().state?null!=this.actions[t].elapsed&&this.actions[t].elapsed():this.actions[t].state==n.running&&null!=this.actions[t].running&&this.actions[t].running())}switchaction(t){this.actions[t].timer?.restart(),this.actions[t].state=n.enabled,t!=this.action&&(this.actions[this.action].state=n.disabled,this.action=t)}}}(l||(l={}));class f{static init=!1;static keys={};constructor(){f.init||(document.addEventListener("keydown",t=>{t.repeat||(f.keys[t.key]=1)}),document.addEventListener("keyup",t=>{f.keys[t.key]=-1})),f.init=!0}static refresh(){for(let t in f.keys)f.keys[t]=f.keys[t]<0?0:f.keys[t]>0?2:0}}class g{constructor(t=!1){}}class y extends g{static physicspool=[];collisionpool=[];constructor(){super(),y.physicspool.push(this)}refresh(){for(let t of y.physicspool){t.collisionpool=t.collisionpool.filter(t=>!t.deleteMe);let e=t.collisionpool.filter(t=>null!=t.self||null==t.self);for(let t of e)t.self&&(t.self.activeeffects=[a.none,a.none,a.none,a.none]);e.forEach(t=>{let s=new Set(e.filter(e=>e.from&t.cwith&&e.self).map(t=>t.self));t.self&&s.delete(t.self),t.update(s)})}}addCollisionTo(t,e){return this.collisionpool.push(e),null!=t&&(t.collisions.push(e),e.self=t),e}}!function(t){t[t.idle=0]="idle",t[t.pan=1]="pan",t[t.zoom=2]="zoom"}(c||(c={}));class w extends g{action=c.idle;actor;freemovement;callback=()=>{};camera;pan=[];zoom=[];constructor(t){super(!0),this.freemovement=new h.Existence,this.camera=t}refresh(){if(this.action!=c.idle){if(this.action==c.pan)for(;this.actor.triggers.length>0;){let t=this.actor.triggers.pop()||{name:""};"pan"==t.name&&("active"==t.state&&(this.actor.pos.x=this.pan[0].x+this.actor.timeouts[0].getTimeoutTicks()/this.actor.timeouts[0].ms[0]*this.pan[1].x,this.actor.pos.y=this.pan[0].y+this.actor.timeouts[0].getTimeoutTicks()/this.actor.timeouts[0].ms[0]*this.pan[1].y,console.log(this.actor.pos)),"triggered"==t.state&&(this.actor.timeouts=[],this.action=c.idle,this.callback()))}if(this.action==c.zoom)for(;this.actor.triggers.length>0;){let t=this.actor.triggers.pop()||{name:""};"zoom"==t.name&&("active"==t.state&&(this.actor.pos.x=this.pan[0].x+this.actor.timeouts[0].getTimeoutTicks()/this.actor.timeouts[0].ms[0]*this.pan[1].x,this.actor.pos.y=this.pan[0].y+this.actor.timeouts[0].getTimeoutTicks()/this.actor.timeouts[0].ms[0]*this.pan[1].y,this.camera.scale.x=this.zoom[0].x+this.actor.timeouts[0].getTimeoutTicks()/this.actor.timeouts[0].ms[0]*this.zoom[1].x,this.camera.scale.y=this.zoom[0].y+this.actor.timeouts[0].getTimeoutTicks()/this.actor.timeouts[0].ms[0]*this.zoom[1].y),"triggered"==t.state&&(this.actor.timeouts=[],this.action=c.idle,this.callback()))}}}panCamera(t,e,i,r=()=>{}){this.actor=this.freemovement,this.actor.pos.x=t.x,this.actor.pos.y=t.y,this.actor.timeouts=[new s.Timeout([i],"pan")],this.pan[0]=t,this.pan[1]={x:e.x-t.x,y:e.y-t.y},this.action=c.pan,this.callback=r}zoomCamera(t,e,i,r,a=()=>{}){this.actor=this.freemovement,this.actor.pos.x=t.x,this.actor.pos.y=t.y,this.actor.timeouts=[new s.Timeout([r],"zoom")],this.pan[0]=t,this.pan[1]={x:e.x-t.x,y:e.y-t.y},this.zoom[0]={x:this.camera.scale.x,y:this.camera.scale.y},this.zoom[1]={x:i.x-this.camera.scale.x,y:i.y-this.camera.scale.y},this.action=c.zoom,this.callback=a}}class b extends g{viewport;bounds;scale={x:1,y:1};cameraman;constructor(t,e){super(),this.viewport={x:0,y:0,w:t.w,h:t.h},this.bounds=e,this.cameraman=new w(this)}refresh(){this.viewport.x=this.cameraman.actor.pos.x-this.viewport.w/2+this.cameraman.actor.hitbox.w/2+this.cameraman.actor.hitbox.x>this.bounds.x?this.cameraman.actor.pos.x+this.viewport.w/2+this.cameraman.actor.hitbox.w/2+this.cameraman.actor.hitbox.x>this.bounds.w?this.bounds.w-this.viewport.w:Math.floor(this.cameraman.actor.pos.x-this.viewport.w/2+this.cameraman.actor.hitbox.w/2+this.cameraman.actor.hitbox.x):this.bounds.x,this.viewport.y=this.cameraman.actor.pos.y-this.viewport.h/2+this.cameraman.actor.hitbox.h/2+this.cameraman.actor.hitbox.y>this.bounds.y?this.cameraman.actor.pos.y+this.viewport.h/2+this.cameraman.actor.hitbox.h/2+this.cameraman.actor.hitbox.y>this.bounds.h?this.bounds.h-this.viewport.h:Math.floor(this.cameraman.actor.pos.y-this.viewport.h/2+this.cameraman.actor.hitbox.h/2+this.cameraman.actor.hitbox.y):this.bounds.y}setbounds(t){this.bounds=t}worldtoscreen(t){return{x:t.pos.x-this.viewport.x,y:t.pos.y-this.viewport.y}}}class T{shaders={};fallbackShader="normal";previousShader="";currShader;gl;constructor(t){this.gl=t}getShader(t=""){let e=this.shaders[t]||this.shaders[this.fallbackShader]||void 0;return void 0===e&&console.log("Shader "+t+" doesn't exist and couldn't find fallback shader "+this.fallbackShader),e}compileShader(t,e){let s=this.gl.createShader(t);return this.gl.shaderSource(s,e),this.gl.compileShader(s),this.gl.getShaderParameter(s,this.gl.COMPILE_STATUS)?s:(console.debug(this.gl.getShaderInfoLog(s)),this.gl.deleteShader(s),null)}createProgram(t,e){let s=this.gl.createProgram();return this.gl.attachShader(s,t),this.gl.attachShader(s,e),this.gl.linkProgram(s),this.gl.getProgramParameter(s,this.gl.LINK_STATUS)?s:(console.debug(this.gl.getProgramInfoLog(s)),this.gl.deleteProgram(s),null)}passShader(t,e,s={}){if(null!=t.rprops.shaderID?this.validateShader(t.rprops.shaderID):this.validateShader(this.fallbackShader),null!=this.currShader){for(const t of this.currShader.second)t();for(const i of this.currShader.passes)i(this.gl,t,e,s)}}validateShader(t){this.previousShader!==t&&(this.currShader=this.shaders[t],null!=this.currShader?(this.initShader(this.currShader),this.previousShader=t):(console.log("Using Fallback shader"),this.currShader=this.shaders[this.fallbackShader]||void 0,null!=this.currShader?this.initShader(this.currShader):console.log("Fallback shader undefined"),this.previousShader=this.fallbackShader))}initShader(t){this.gl.useProgram(t.program);for(const t of this.currShader.first)t(this.gl)}}class E{constructor(){}}class A{static iM=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];static ortho(t,e,s,i,r,a){return new Float32Array([i,0,0,0,0,r,0,0,0,0,a,0,t,e,s,1])}static multiplyMatrices(t,e){let s=[e[0],e[1],e[2],e[3]],i=[e[4],e[5],e[6],e[7]],r=[e[8],e[9],e[10],e[11]],a=[e[12],e[13],e[14],e[15]],o=this.multiplyMatrixAndPoint(t,s),h=this.multiplyMatrixAndPoint(t,i),n=this.multiplyMatrixAndPoint(t,r),l=this.multiplyMatrixAndPoint(t,a);return new Float32Array([o[0],o[1],o[2],o[3],h[0],h[1],h[2],h[3],n[0],n[1],n[2],n[3],l[0],l[1],l[2],l[3]])}static multiplyMatrixAndPoint(t,e){let s=t[0],i=t[1],r=t[2],a=t[3],o=t[4],h=t[5],n=t[6],l=t[7],c=t[8],p=t[9],d=t[10],u=t[11],x=t[12],m=t[13],f=t[14],g=t[15],y=e[0],w=e[1],b=e[2],T=e[3];return[y*s+w*o+b*c+T*x,y*i+w*h+b*p+T*m,y*r+w*n+b*d+T*f,y*a+w*l+b*u+T*g]}static rotation(t,e){return this.multiplyMatrices(t,[Math.cos(e),-Math.sin(e),0,0,Math.sin(e),Math.cos(e),0,0,0,0,1,0,0,0,0,1])}static normalize(t,e,s){return t[0]=t[0]/e,t[5]=t[5]/s,t[12]=t[12]/e,t[13]=t[13]/s,t}static orthographic(t,e,s,i,r,a,o=new Float32Array(16)){return o[0]=2/(e-t),o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=2/(i-s),o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[10]=2/(r-a),o[11]=0,o[12]=(t+e)/(t-e),o[13]=(s+i)/(s-i),o[14]=(r+a)/(r-a),o[15]=1,o}static scale(t,e,s,i,r=new Float32Array(16)){return r[0]=e*t[0],r[1]=e*t[1],r[2]=e*t[2],r[3]=e*t[3],r[4]=s*t[4],r[5]=s*t[5],r[6]=s*t[6],r[7]=s*t[7],r[8]=i*t[8],r[9]=i*t[9],r[10]=i*t[10],r[11]=i*t[11],t!==r&&(r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15]),r}static translate(t,e,s,i,r=new Float32Array(16)){var a=t[0],o=t[1],h=t[2],n=t[3],l=t[4],c=t[5],p=t[6],d=t[7],u=t[8],x=t[9],m=t[10],f=t[11],g=t[12],y=t[13],w=t[14],b=t[15];return t!==r&&(r[0]=a,r[1]=o,r[2]=h,r[3]=n,r[4]=l,r[5]=c,r[6]=p,r[7]=d,r[8]=u,r[9]=x,r[10]=m,r[11]=f),r[12]=a*e+l*s+u*i+g,r[13]=o*e+c*s+x*i+y,r[14]=h*e+p*s+m*i+w,r[15]=n*e+d*s+f*i+b,r}static mat4mul(t,e){const s=[];for(let i=0;i<4;i++)for(let r=0;r<4;r++){const a=t[4*i+0]*e[0+r]+t[4*i+1]*e[4+r]+t[4*i+2]*e[8+r]+t[4*i+3]*e[12+r];s[4*i+r]=a}return new Float32Array(s)}static mat4translation(t){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,t.x,t.y,0,1])}static mat4rot(t){return new Float32Array([Math.cos(t),-Math.sin(t),0,0,Math.sin(t),Math.cos(t),0,0,0,0,1,0,0,0,0,1])}}class v extends E{program;name="reverser";matrixLocation;textureMatrixLocation;texture;second=[()=>{}];first=[t=>{let e=t,s=e.getAttribLocation(this.program,"aVertexPosition");e.enableVertexAttribArray(s),e.vertexAttribPointer(s,2,e.FLOAT,!1,0,0);let i=e.getAttribLocation(this.program,"texcoordLocation");e.enableVertexAttribArray(i),e.vertexAttribPointer(i,2,e.FLOAT,!1,0,0),this.matrixLocation=e.getUniformLocation(this.program,"matrixLocation"),this.textureMatrixLocation=e.getUniformLocation(this.program,"textureMatrixLocation"),this.texture=e.getUniformLocation(this.program,"texture")}];passes=[(t,e,s,i)=>{let r=t,a=new Float32Array([e.rprops.dstrect.w,0,0,0,0,e.rprops.dstrect.h,0,0,0,0,1,0,s.x,s.y,0,1]);if(a[0]*=2/s.w,a[5]*=-2/s.h,a[12]=a[12]*(2/s.w)-1,a[13]=-a[13]*(2/s.h)+1,r.uniformMatrix4fv(this.matrixLocation,!1,a),null!=this.textureMatrixLocation){let t=A.orthographic(-1,1,1,-1,-1,1);r.uniformMatrix4fv(this.textureMatrixLocation,!1,t)}}]}class F extends E{program;name="normal";matrixLocation;textureMatrixLocation;texture;second=[()=>{}];first=[t=>{let e=t,s=e.getAttribLocation(this.program,"aVertexPosition");e.enableVertexAttribArray(s),e.vertexAttribPointer(s,2,e.FLOAT,!1,0,0);let i=e.getAttribLocation(this.program,"texcoordLocation");e.enableVertexAttribArray(i),e.vertexAttribPointer(i,2,e.FLOAT,!1,0,0),this.matrixLocation=e.getUniformLocation(this.program,"matrixLocation"),this.textureMatrixLocation=e.getUniformLocation(this.program,"textureMatrixLocation")}];passes=[(t,e,s,i)=>{let r=t,a=e.rprops.dstrect.h*(-2/s.h),o=e.rprops.dstrect.w*(2/s.w),h=new Float32Array([o,0,0,0,0,a,0,0,0,0,1,0,0,0,0,1]),n={x:0,y:0};null!=e.rprops.scalecenter&&(n={x:e.rprops.scalecenter.x*(2/s.w),y:e.rprops.scalecenter.y*(-2/s.h)}),n={x:(0-n.x)*e.rprops.scale.x+n.x,y:a-(a-n.y)*e.rprops.scale.y-n.y},h=A.mat4mul(h,A.mat4translation({x:n.x,y:n.y})),h=A.scale(h,e.rprops.scale.x,e.rprops.scale.y,1);let l={x:0,y:0};if(null!=e.rprops.rotcenter&&(l={x:e.rprops.rotcenter.x*(2/s.w),y:(e.rprops.dstrect.h-e.rprops.rotcenter.y)*(-2/s.h)}),h=A.mat4mul(h,A.mat4translation({x:-l.x,y:-l.y})),h=A.mat4mul(h,A.mat4rot(e.rprops.angle)),h=A.mat4mul(h,A.mat4translation({x:l.x,y:l.y})),h[12]+=Math.round(s.x)*(2/s.w)-1,h[13]+=-Math.round(s.h-s.y-e.rprops.dstrect.h)*(2/s.h)+1,r.uniformMatrix4fv(this.matrixLocation,!1,h),null!=this.textureMatrixLocation){let t=A.orthographic(-1,1,-1,1,-1,1);t=A.translate(t,0,1,0),e.rprops.flip.flipx&&e.rprops.flip.flipy?(t=A.orthographic(1,-1,1,-1,-1,1),t=A.translate(t,-1,0,0)):e.rprops.flip.flipx?(t=A.orthographic(1,-1,-1,1,-1,1),t=A.translate(t,-1,1,0)):e.rprops.flip.flipy&&(t=A.orthographic(-1,1,1,-1,-1,1)),r.uniformMatrix4fv(this.textureMatrixLocation,!1,t)}}]}class R extends E{program;name="whitetransparent";matrixLocation;textureMatrixLocation;texture;second=[()=>{}];first=[t=>{let e=t,s=e.getAttribLocation(this.program,"aVertexPosition");e.enableVertexAttribArray(s),e.vertexAttribPointer(s,2,e.FLOAT,!1,0,0);let i=e.getAttribLocation(this.program,"texcoordLocation");e.enableVertexAttribArray(i),e.vertexAttribPointer(i,2,e.FLOAT,!1,0,0),this.matrixLocation=e.getUniformLocation(this.program,"matrixLocation"),this.textureMatrixLocation=e.getUniformLocation(this.program,"textureMatrixLocation")}];passes=[(t,e,s,i)=>{let r=t,a=new Float32Array([e.rprops.dstrect.w,0,0,0,0,e.rprops.dstrect.h,0,0,0,0,1,0,e.rprops.dstrect.x,s.h-e.rprops.dstrect.y-e.rprops.dstrect.h,0,1]);if(0!=e.rprops.angle){let t=[];t[0]=Math.cos(-e.rprops.angle)*a[0],t[1]=-Math.sin(-e.rprops.angle)*a[0],t[3]=Math.sin(-e.rprops.angle)*a[5],t[4]=Math.cos(-e.rprops.angle)*a[5],a[0]=t[0],a[1]=t[1],a[4]=t[3],a[5]=t[4]}if(a[0]*=2/s.w,a[1]*=2/s.w,a[4]*=-2/s.h,a[5]*=-2/s.h,a[12]=a[12]*(2/s.w)-1,a[13]=-a[13]*(2/s.h)+1,r.uniformMatrix4fv(this.matrixLocation,!1,a),null!=this.textureMatrixLocation){let t=A.orthographic(-1,1,-1,1,-1,1);t=A.translate(t,0,1,0),e.rprops.flip.flipx&&e.rprops.flip.flipy||(e.rprops.flip.flipx?(t=A.orthographic(1,-1,-1,1,-1,1),t=A.translate(t,-1,1,0)):e.rprops.flip.flipy),r.uniformMatrix4fv(this.textureMatrixLocation,!1,t)}}]}class M extends T{shaderts;constructor(t,e=[new F,new v,new R]){super(t),this.shaderts=e}async init(){await this.compileAllShadersFrom("shaders/")}async compileAllShadersFrom(t){let e=[];await Promise.all(await m.loadAllExtInFolder(t,["frag","vert"])).then(t=>{t.map((t,s,i)=>{let r=t.split("/")[1].split(".")[0];for(let t=s;t<i.length;t++)r!=i[t].split("/")[1].split(".")[0]||e.includes(r)||e.push(r)})});for(let t=0;t<e.length;t++)this.shaders[e[t]]=(()=>{let s=this.compileShader(this.gl.VERTEX_SHADER,m.getText("shaders/"+e[t]+".vert")),i=this.compileShader(this.gl.FRAGMENT_SHADER,m.getText("shaders/"+e[t]+".frag")),r=this.createProgram(s,i);r||console.log("Shader creation unsuccessful:"+this.shaders[e[t]]);for(let s=0;s<this.shaderts.length;s++)if(this.shaderts[s].name==e[t]&&null!=r)return this.shaderts[s].program=r,this.shaderts[s];return this.shaderts[0]})();return e}}class C{source;target;frm;static windows=[];constructor(t,e=null){this.source=t,this.target=e,C.windows.push(this)}static refresh(){C.windows.forEach(t=>t.update())}update(){if(this.frm.compose(),null!=this.target);else{var t=this.source.gl;t.bindFramebuffer(t.FRAMEBUFFER,null),t.viewport(0,0,t.canvas.width,t.canvas.height),t.clear(t.COLOR_BUFFER_BIT),t.bindTexture(t.TEXTURE_2D,this.frm.texture);let e=r.Frame.createFocus(this.frm.frame);this.frm.shadercontext.passShader(this.frm,{x:e.x,y:e.y,w:t.canvas.width,h:t.canvas.height}),t.drawArrays(t.TRIANGLES,0,6)}}}class S{static loadCSV(t){return{tileYX:t.split("\n").filter(t=>""!=t).map(t=>t.split(",").map(t=>Number(t)))}}static async loadIni(t){let e,s,i,r=[],a="",o=[],h={w:16,h:16},n="";const l=m.getText(await m.addText(t)).split("\n");for(let t=0;t<l.length;t++){const s=l[t].split(" ");switch(s[0]){case"TILESET":const t=s[1].split(":");switch(t[0]){case"SQUARE":h={w:Number(t[1]),h:Number(t[1])};break;case"FILE":e=await m.addImage(t[1]),n=t[1]}break;case"PLAYGROUND":i=Number(s[1]);break;case"CSV":let l=s[1].split(":");const c=m.getText(await m.addText(l[1]));r[Number(l[0])]={tileYX:c.split("\n").filter(t=>""!=t).map(t=>t.split(",").map(t=>Number(t)))};break;case"NPCS":a=m.getText(await m.addText(s[1]));break;case"COLLISION":const p=m.getText(await m.addText(s[1])).trim().split("\n");let d=[];for(let t of p)d.push(t.split(",").map(t=>!(Number(t)<0)));o.push(d),console.log(o)}}return s=m.getTextureWidth(n)-m.getTextureWidth(n)%h.w,{tiles:r,npcs:a,collisions:o,tileset:e,tilesetwidth:s,square:h,playLayer:i,grid:{w:r[0].tileYX[0].length,h:r[0].tileYX.length}}}}class k{static blit(t,e,s,i){let a=-1;return s.tiles.map(o=>{a++,console.log(o),t.gl.createFramebuffer(),t.gl.bindFramebuffer(t.gl.FRAMEBUFFER,t.framebuffer);const h=s.square.w*o.tileYX[0].length,n=s.square.h*o.tileYX.length,l=s.tilesetwidth/s.square.w;let c=x.createTexToBlitOn(t,h,n);t.gl.framebufferTexture2D(t.gl.FRAMEBUFFER,t.gl.COLOR_ATTACHMENT0,t.gl.TEXTURE_2D,s.texture,0),t.gl.bindTexture(t.gl.TEXTURE_2D,c);for(let e=0;e<o.tileYX.length;e++)for(let i=0;i<o.tileYX[e].length;i++)t.gl.copyTexSubImage2D(t.gl.TEXTURE_2D,0,i*s.square.w,e*s.square.h,o.tileYX[e][i]%l*s.square.w,Math.floor(o.tileYX[e][i]/l)*s.square.h,s.square.w,s.square.h);t.addTexture(i+a,c);let p=new r.Image(t,e,i+a,{x:0,y:0,w:h,h:n},{x:0,y:0,w:h,h:n}),d=new r.Snap(t,e,[p]);return d.rprops.layer=a-s.playLayer,d})}}!function(t){t.Level=class{bodies=[];representation;levelsize;grids;cellbuild;async load(){this.cellbuild=await S.loadIni("_assets/"+this.ininame),this.levelsize={w:this.cellbuild.tiles[0].tileYX[0].length*this.cellbuild.square.w,h:this.cellbuild.tiles[0].tileYX.length*this.cellbuild.square.h}}async buildCell(t,e,s){this.cellbuild=await S.loadIni(t),this.cellbuild.texture=m.retrieveTex(this.cellbuild.tileset,e),this.levelsize={w:this.cellbuild.tiles[0].tileYX[0].length*this.cellbuild.square.w,h:this.cellbuild.tiles[0].tileYX.length*this.cellbuild.square.h},this.representation=k.blit(e,s,this.cellbuild,"level-layer")}},t.SharedObject=class{presence;pos;anisrc={};currentani;hitbox;ownerid;ownername;dir;constructor(t){this.pos=t.pos,this.anisrc=t.anisrc,this.currentani=t.currentani,this.hitbox=t.hitbox,this.ownerid=t.owner.id,this.ownername=t.owner.name,this.dir=t.dir}update(){}};class e extends l.Fauna{}t.Fauna=e;class s extends l.Incarnated{hp={max:3,current:3};myCamera;keyboardactions={};registerkey(t,e){this.keyboardactions[t]=e}updatekeys(){for(let t in this.keyboardactions){let e=this.keyboardactions[t];if(null!=f.keys[t])switch(f.keys[t]){case-1:null!=e.keyup&&e.keyup();break;case 0:break;case 1:null!=e.keydown&&e.keydown(),null!=e.keypressed&&e.keypressed();break;case 2:null!=e.keyheld&&e.keyheld(),null!=e.keypressed&&e.keypressed()}}}update(){super.update(),this.updatekeys()}}t.Player=s,t.GameAnimations=class{}}(p||(p={}));class L{static parse(t){let e=[],s="",i=[];for(let t=0;t<4;t++)i.push({frames:[]});let r=!1,a={HEAD:"",BODY:"",SWORD:"redlightsabersword.png"},o=t.split("\n").map(t=>t.trim());for(let t=0;t<o.length;t++){let e=o[t].split(" ");switch(e.shift()){case"DEFAULTHEAD":a.HEAD=e.join(" ");break;case"DEFAULTBODY":a.BODY=e.join(" ")}}let h=0;for(let t=0;t<o.length;t++)if(r){if(o[t].startsWith("ANIEND"))break;if(o[t].startsWith("PLAYSOUND"))continue;let s=300;if(o[t].startsWith("WAIT")){s=1e3*Number(o[t].split(" ")[1]);continue}let r=o[t].split(",").filter(t=>""!=t);if(r.length>0){let t=[];for(let s=0;s<r.length;s++){let i=r[s].split(" ").filter(t=>""!=t);""!==e[Number(i[0])].file&&t.push({file:e[Number(i[0])].file,srcrect:e[Number(i[0])].srcrect,dstrect:{x:Number(i[1]),y:Number(i[2]),w:e[Number(i[0])].srcrect.w,h:e[Number(i[0])].srcrect.h}})}i[h].frames.push(t),h=(h+1)%4}}else{let i=o[t].split(" ").filter(t=>""!=t);switch(i.shift()){case"SPRITE":e[Number(i[0])]={file:null==a[i[1]]?"":"_assets/arbre/"+a[i[1]],srcrect:{x:Number(i[2]),y:Number(i[3]),w:Number(i[4]),h:Number(i[5])}};break;case"ATTACHSPRITE":case"LOOP":case"CONTINUOUS":case"SINGLEDIRECTION":break;case"ANI":r=!0;break;case"SETBACKTO":s=i.join(" ")}}return console.log(i),{properties:0,next:s,animations:i}}}class D{deleteMe=!1;from;cwith;type;self;offY;offX;width;height;ogBounds={x:0,y:0,w:0,h:0};padding={x:1,y:1};constructor(t,e,s){this.from=t,this.cwith=e,this.type=s}update(t){for(let e of t)this.intersect(e)}static inBounds(t,e,s){return t>s.x&&t<s.x+s.w&&e>s.y&&e<s.y+s.h}computeCollidePoints(t,e={x:1,y:1},s={w:1,h:1},i=0){let r=[[Math.max(0,Math.floor((t.x+2*e.x)/s.w))>>>i,Math.max(0,Math.floor(t.x/s.w))>>>i,Math.max(0,Math.floor((t.x+t.w-2*e.x)/s.w))>>>i,Math.max(0,Math.floor((t.x+t.w)/s.w))>>>i],[Math.max(0,Math.floor((t.y+2*e.y)/s.h)),Math.max(0,Math.floor(t.y/s.h)),Math.max(0,Math.floor((t.y+t.h-2*e.y)/s.h)),Math.max(0,Math.floor((t.y+t.h)/s.h))]];return[[[r[0][0],r[0][2]],[r[1][1],r[1][1]]],[[r[0][1],r[0][1]],[r[1][0],r[1][2]]],[[r[0][0],r[0][2]],[r[1][3],r[1][3]]],[[r[0][3],r[0][3]],[r[1][0],r[1][2]]]]}}class U extends D{hitbox;owner;call;constructor(t,e,s,i,r){super(o.none,t,e),this.owner=s,this.hitbox=i,this.call=r,s.collisions.push(this)}intersect(t){let e=this.owner.pos.x+this.hitbox.x,s=this.owner.pos.y+this.hitbox.y,i=this.hitbox.w,r=this.hitbox.h,a=t.pos.x+t.hitbox.x,o=t.pos.y+t.hitbox.y,h=t.hitbox.w,n=t.hitbox.h;e<a+h&&e+i>a&&s<o+n&&s+r>o&&0==this.deleteMe&&(this.deleteMe=this.call(this.owner,t))}}class _ extends D{constructor(t,e,s,i){super(e,s,i),this.self=t,this.padding={x:8,y:8},t.collisions.push(this)}intersect(t){const e={x:t.pos.x+t.hitbox.x,y:t.pos.y+t.hitbox.y,w:t.hitbox.w,h:t.hitbox.h},s=(this.computeCollidePoints(e,this.padding),this.self.pos.x+this.self.hitbox.x),i=this.self.pos.y+this.self.hitbox.y,r=this.self.hitbox.w,o=this.self.hitbox.h;let h=[a.none,a.none,a.none,a.none];(e.x>s&&e.x+this.padding.x<s+r||e.x+e.w-this.padding.x>s&&e.x+e.w<s+r)&&(h[0]|=i+o-e.y>0&&e.y>i?this.type:a.none,h[2]|=i-(e.y+e.h)<0&&e.y+e.h<i+o?this.type:a.none),(e.y>i&&e.y+this.padding.y<i+o||e.y+e.w-this.padding.y>i&&e.y+e.w<i+o)&&(h[1]|=s+r-e.x>0&&e.x>s?this.type:a.none,h[3]|=s-(e.x+e.w)<0&&e.x+e.w<s+r?this.type:a.none);for(let e=0;e<4;e++)t.activeeffects[e]|=h[e]}static checkBounds(t,e){return D.inBounds(t[0][0],t[1][0],e)||D.inBounds(t[0][1],t[1][1],e)}}class B extends D{padding={x:2,y:2};resolution=16;walls=[];static sizeBit=5;static bitSize=1<<this.sizeBit;ylimit;xlimit;constructor(t,e,s,i){super(o.grid,s,i),this.ylimit=t.length;let r=t[0].length;this.xlimit=Math.ceil(t[0].length/B.bitSize);let a=t.flat(1/0),h=0;this.resolution=e;for(let t=0;t<a.length;t+=r){this.walls.push(Array());for(let e=0;e<r;e+=B.bitSize){let s=0;for(let i=0;i<B.bitSize&&!(e+i>=r);i++)1==a[t+e+i]&&(s|=1<<i);this.walls[h].push(s)}h+=1}}againstGrid(t,e,s){let i=t,r=e;if(r>=this.ylimit||r<0)return!1;let a=1<<Math.floor(s/this.resolution)%B.bitSize;return!(i>=this.xlimit||i<0)&&0!=(this.walls[r][i]&a)}testWall(t){return this.againstGrid(Math.floor(t.x/this.resolution)>>>B.sizeBit,Math.floor(t.y/this.resolution),t.x)}intersect(t){const e=this.computeCollidePoints({x:t.pos.x+t.hitbox.x,y:t.pos.y+t.hitbox.y,w:t.hitbox.w,h:t.hitbox.h},this.padding,{w:this.resolution,h:this.resolution},B.sizeBit);this.checkCollisionDirection(t,0,e[0][0][0],e[0][1][0],t.pos.x+t.hitbox.x+2*this.padding.x,e[0][0][1],e[0][1][1],t.pos.x+t.hitbox.x+t.hitbox.w-2*this.padding.x),this.checkCollisionDirection(t,1,e[1][0][0],e[1][1][0],t.pos.x+t.hitbox.x,e[1][0][1],e[1][1][1],t.pos.x+t.hitbox.x),this.checkCollisionDirection(t,2,e[2][0][0],e[2][1][0],t.pos.x+t.hitbox.x+2*this.padding.x,e[2][0][1],e[2][1][1],t.pos.x+t.hitbox.x+t.hitbox.w-2*this.padding.x),this.checkCollisionDirection(t,3,e[3][0][0],e[3][1][0],t.pos.x+t.hitbox.x+t.hitbox.w-this.padding.x,e[3][0][1],e[3][1][1],t.pos.x+t.hitbox.x+t.hitbox.w-this.padding.x)}checkCollisionDirection(t,e,s,i,r,o,h,n){const l=this.againstGrid(s,i,r),c=this.againstGrid(o,h,n);t.activeeffects[e]|=l||c?this.type:a.none}}!function(t){class e{gameid;alacritypool=[];systempool=[];paused=!1;rootFolder="_assets/";cellbuild;fileextensions=["png","gani","wav","csv"];gameframe;currentLevel=void 0;window;glContext;shadercontext;static gamespool=[];remoteobjects={};loadedobjquant=0;animationsobject;constructor(t,s,a,o=[new F,new v,new R]){this.glContext=new i.GLContext(t,s+"",a+""),this.shadercontext=new M(this.glContext.gl,o),e.gamespool.push(this),this.gameid=e.gamespool.length-1,this.window=new C(this.glContext),this.window.frm=new r.Frame(this.glContext,this.shadercontext,[]),this.window.frm.rprops.srcrect={x:0,y:0,w:this.glContext.gl.canvas.width,h:this.glContext.gl.canvas.height},this.window.frm.rprops.shaderID="reverser"}async load(){await this.initialize()}async initialize(t=!0,e=!0){t&&new f,null==this.gamename||""==this.gamename?await Promise.all(await m.loadAllExtInFolder(this.rootFolder,this.fileextensions)):await Promise.all(await m.loadAllExtInFolder(this.rootFolder+this.gamename+"/",this.fileextensions)),await Promise.all(await m.loadAllExtInFolder(this.rootFolder+"_debug/",this.fileextensions)),await this.shadercontext.init()}run(t){for(let e=this.loadedobjquant;e<t.length;e++){let s=t[e];if(s.owner.id==this.gameid)continue;let i=new p.SharedObject(s);i.presence=new l.Incarnated(new r.Frame(this.glContext,this.shadercontext,[])),i.presence.pos=i.pos,i.presence.dir=i.dir,i.presence.anims=this.loadAnims(i.anisrc),i.presence.switchanimation(i.currentani),this.remoteobjects[t[e].id]=i,this.gameframe.frame.push(i.presence.myFrame)}this.loadedobjquant=t.length;for(let t of this.systempool)t.refresh();for(let e of t){let t=this.remoteobjects[e.id];t&&(t.presence.switchanimation(e.currentani),t.presence.dir=e.dir,t.presence.myFrame.rprops.pos=e.pos)}this.paused||this.refreshalacrities(),h.Alacrity.resetallmovements(this.alacritypool)}refreshalacrities(){this.alacritypool=this.alacritypool.filter(t=>!t.delete);for(let t=0;t<this.alacritypool.length;t++)this.alacritypool[t].update();for(let t=0;t<this.alacritypool.length;t++)this.alacritypool[t].finalize()}loadAnims(t){let e={};for(let s in t){let i=t[s],r=L.parse(m.getText(i)).animations,a=[];for(let t of r)a.push(this.buildAni(t));e[s]=a}return e}async newTiledLevel(t){if(void 0!==this.currentLevel){for(let t of this.currentLevel.representation)t.rprops.delete=!0;for(let t of this.currentLevel.bodies)t.myFrame.rprops.delete=!0}let e=this.levels[t];return await e.load(),e}displayLevel(t){null==this.gameframe?(this.gameframe=new r.Frame(this.glContext,this.shadercontext,[...t.representation,...t.bodies.map(t=>t.myFrame)]),this.gameframe.camera=new b(this.srcview,{x:0,y:0,...t.levelsize})):(this.gameframe.camera.setbounds({x:0,y:0,...t.levelsize}),this.gameframe.addtocomposition([...t.representation,...t.bodies.map(t=>t.myFrame)]))}buildAni(t){let e=new r.Animation(this.glContext,this.shadercontext,[]);for(let s of t.frames)e.frames.push(this.buildSnap(s));return e}buildSnap(t){let e=new r.Snap(this.glContext,this.shadercontext,[]);for(let s of t)e.parts.push(new r.Image(this.glContext,this.shadercontext,s.file,s.srcrect,s.dstrect));return e}newFrame(t){return new r.Frame(this.glContext,this.shadercontext,t)}newRectangle(t,e){return new r.Rectangle(this.glContext,this.shadercontext,t,e)}newSnap(t){return new r.Snap(this.glContext,this.shadercontext,t)}newText(t,e={}){return new r.Text(this.glContext,this.shadercontext,t,e)}registerEntity(t,e=this.window.frm){this.alacritypool.push(t),e.frame.push(t.myFrame)}}t.Generic=e;class s extends e{gamephysics;async initialize(t=!0,e=!0){await super.initialize(t,e),this.gamephysics=new y,this.systempool.push(this.gamephysics)}async newTiledLevel(t){return await super.newTiledLevel(t)}addCapture(t){this.gamephysics.collisionpool.push(new U(t.cwith,t.type,t.owner,t.hitbox,t.call))}addAsCollision(t,e,s,i){this.gamephysics.collisionpool.push(new _(t,e,s,i))}addGrid(t,e,s,i){this.gamephysics.collisionpool.push(new B(t,e,s,i))}}t.Action=class extends s{player;async newTiledLevel(t){return await super.newTiledLevel(t)}}}(d||(d={}));class N{static paused=!0;static games=[];static sharedobjects=[];constructor(t){}static async start(t){m.initAudio(),await t.load()}static mainLoop=()=>{s.Delta.refresh(),N.games.forEach(t=>{t.run(N.sharedobjects),t.window.update()}),f.refresh(),requestAnimationFrame(N.mainLoop)}}class P extends p.Level{}class z extends p.Player{}class I extends p.Fauna{}class O extends d.Action{parseGani(t){return L.parse(m.getText(t)).animations.map(t=>this.buildAni(t))}}class X extends r.Animation{}class G extends r.Frame{}class Y extends r.Rectangle{}class j{static playSound(t){m.playSound(t)}static imageFromCSV(t,e){return t.cellbuild.tiles=[S.loadCSV(m.getText(e))],k.blit(t.glContext,t.shadercontext,t.cellbuild,"Tree")[0]}static async preloadText(t){await m.addText(t)}}window.TEWOU=e})();