<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Timeout Test</title>
  <link rel="stylesheet" href="../test-common.css">
</head>
<body>
  <div class="test-container">
    <div class="test-header">
      <h1>Timeout Test</h1>
      <p>Tests the <code>addTimeout()</code> method for creating timed events and triggers.</p>
    </div>

    <div class="canvas-wrapper">
      <canvas id="canvas"></canvas>
    </div>

    <div class="test-info">
      <h2>Test Status</h2>
      <ul id="test-status"></ul>
    </div>

    <div class="expected-result">
      <h3>Expected Result</h3>
      <p>You should see various timers counting down, triggering actions at specific intervals. Timers can be one-shot or repeating.</p>
    </div>

    <div class="log" id="log"></div>
  </div>

  <script src="../test-utils.js"></script>
  <script src="../../../engine/dist/engine.js"></script>
  <script>
    const logger = new TestLogger();
    const status = new TestStatus();

    logger.info('Starting Timeout Test');

    class TimeoutTestGame extends TEWOU.ActionGame {
      constructor(canvas) {
        super(canvas, 1000, 700);
        this.gamename = "timeout-test";
        this.fileextensions = [];
      }

      async load() {
        await super.load();
        logger.success('Game initialized');
      }
    }

    var game;

    // One-shot timeout
    class OneShotTimer extends TEWOU.Fauna {
      constructor(x, y, duration) {
        const bg = game.newRectangle(
          { x: 0, y: 0, w: 150, h: 100 },
          { r: 100, g: 150, b: 200, a: 255 }
        );

        const label = game.newText("One-Shot", {
          color: { r: 255, g: 255, b: 255, a: 255 },
          size: 16,
          font: "monospace"
        });
        label.rprops.dstrect.x = 10;
        label.rprops.dstrect.y = 10;

        const timerText = game.newText(duration.toString(), {
          color: { r: 255, g: 255, b: 0, a: 255 },
          size: 32,
          font: "monospace"
        });
        timerText.rprops.dstrect.x = 50;
        timerText.rprops.dstrect.y = 50;

        super(game.newFrame([bg, label, timerText]));

        this.pos.x = x;
        this.pos.y = y;
        this.bg = bg;
        this.timerText = timerText;
        this.duration = duration;

        // Add one-shot timeout and store reference
        this.timeout = this.addTimeout([duration], {
          triggered: () => {
            this.switchAction('none');
            this.bg.rprops.colorize = { r: 100, g: 255, b: 100, a: 255 };
            this.timerText.setText("DONE!");
            logger.success(`One-shot timer (${duration}ms) triggered!`);
          }
        }, false); // repeat = false

        this.actions = {
          counting: {
            state: 2,
            running: () => {
              const elapsed = this.timeout.getTimeoutTicks();
              const remainingMs = Math.max(0, this.duration - elapsed);
              const seconds = Math.ceil(remainingMs / 1000);
              this.timerText.setText(seconds + "s");
            }
          },
          none:{
            state:0
          }
        };
        this.action = "counting";

        game.registerEntity(this);
      }
    }

    // Repeating timeout
    class RepeatingTimer extends TEWOU.Fauna {
      constructor(x, y, interval) {
        const bg = game.newRectangle(
          { x: 0, y: 0, w: 150, h: 100 },
          { r: 200, g: 100, b: 150, a: 255 }
        );

        const label = game.newText("Repeating", {
          color: { r: 255, g: 255, b: 255, a: 255 },
          size: 16,
          font: "monospace"
        });
        label.rprops.dstrect.x = 10;
        label.rprops.dstrect.y = 10;

        const counterText = game.newText("0", {
          color: { r: 255, g: 255, b: 0, a: 255 },
          size: 32,
          font: "monospace"
        });
        counterText.rprops.dstrect.x = 60;
        counterText.rprops.dstrect.y = 50;

        super(game.newFrame([bg, label, counterText]));

        this.pos.x = x;
        this.pos.y = y;
        this.bg = bg;
        this.counterText = counterText;
        this.count = 0;

        // Add repeating timeout
        this.addTimeout([interval], {
          triggered: () => {
            this.count++;
            this.counterText.setText(this.count.toString());

            // Flash color
            this.bg.rprops.colorize = { r: 255, g: 200, b: 100, a: 255 };

            setTimeout(() => {
              this.bg.rprops.colorize = { r: 200, g: 100, b: 150, a: 255 };
            }, 100);

            logger.info(`Repeating timer triggered (count: ${this.count})`);
          }
        }, true); // repeat = true

        this.actions = {
          idle: {
            state: 1,
            running: () => {}
          }
        };
        this.action = "idle";

        game.registerEntity(this);
      }
    }

    // Multi-stage timeout
    class MultiStageTimer extends TEWOU.Fauna {
      constructor(x, y) {
        const bg = game.newRectangle(
          { x: 0, y: 0, w: 150, h: 120 },
          { r: 150, g: 150, b: 150, a: 255 }
        );

        const label = game.newText("Multi-Stage", {
          color: { r: 255, g: 255, b: 255, a: 255 },
          size: 14,
          font: "monospace"
        });
        label.rprops.dstrect.x = 10;
        label.rprops.dstrect.y = 10;

        const stageText = game.newText("Stage 1", {
          color: { r: 255, g: 255, b: 0, a: 255 },
          size: 18,
          font: "monospace"
        });
        stageText.rprops.dstrect.x = 25;
        stageText.rprops.dstrect.y = 60;

        super(game.newFrame([bg, label, stageText]));

        this.pos.x = x;
        this.pos.y = y;
        this.bg = bg;
        this.stageText = stageText;

        const colors = [
          { r: 200, g: 100, b: 100, a: 255 },
          { r: 100, g: 200, b: 100, a: 255 },
          { r: 100, g: 100, b: 200, a: 255 },
          { r: 200, g: 200, b: 100, a: 255 }
        ];

        this.actions = {
          idle: {
            state: 1,
            running: () => {}
          }
        };
        this.action = "idle";

        // Use continuous timeout with multiple stages
        this.addTimeout(
          [1500, 1500, 1500, 1500], // 1.5 seconds for each of 4 stages
          {
            triggered: (timeout) => {
              const stage = timeout.step + 1; // step is 0-indexed, display as 1-indexed
              if (stage <= 4) {
                this.bg.rprops.colorize = colors[stage - 1];
                this.stageText.setText(`Stage ${stage}`);
                logger.info(`Multi-stage timer: Stage ${stage} completed`);
              } else {
                this.stageText.setText("Done!");
                logger.success('Multi-stage timer: All stages complete');
              }
            }
          },
          false, // repeat = false (one-shot through all stages)
          true   // continuous = true (progress through stages)
        );

        game.registerEntity(this);
      }
    }

    // Initialize game
    game = new TimeoutTestGame(document.getElementById('canvas'));
    TEWOU.Engine.start(game).then(() => {
      logger.info('Creating timeout test entities');

      // One-shot timers
      new OneShotTimer(50, 50, 2000);   // 2 seconds
      new OneShotTimer(50, 180, 3000);  // 3 seconds
      new OneShotTimer(50, 310, 5000);  // 5 seconds

      logger.success('Created one-shot timers');
      status.addTest('oneshot-timers', 'One-shot timers');
      status.pass('oneshot-timers', '3 timers: 2s, 3s, 5s');

      // Repeating timers
      new RepeatingTimer(250, 50, 1000);   // Every 1 second
      new RepeatingTimer(250, 180, 1500);  // Every 1.5 seconds
      new RepeatingTimer(250, 310, 2000);  // Every 2 seconds

      logger.success('Created repeating timers');
      status.addTest('repeating-timers', 'Repeating timers');
      status.pass('repeating-timers', '3 timers: 1s, 1.5s, 2s intervals');

      // Multi-stage timers
      new MultiStageTimer(450, 50);
      new MultiStageTimer(650, 50);

      logger.success('Created multi-stage timers');
      status.addTest('multistage-timers', 'Multi-stage timers');
      status.pass('multistage-timers', '2 timers with sequential stages');

      TEWOU.Engine.games.push(game);
      TEWOU.Engine.mainLoop();

      logger.success('Test running - watch timers trigger');
    }).catch(err => {
      logger.error('Failed to start test: ' + err.message);
      status.fail('oneshot-timers', err.message);
    });
  </script>
</body>
</html>
