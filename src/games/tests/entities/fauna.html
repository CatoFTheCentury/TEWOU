<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fauna Entity Test</title>
  <link rel="stylesheet" href="../test-common.css">
</head>
<body>
  <div class="test-container">
    <div class="test-header">
      <h1>Fauna Entity Test</h1>
      <p>Tests the <code>TEWOU.Fauna</code> base class for creating non-player characters and entities with action states.</p>
    </div>

    <div class="canvas-wrapper">
      <canvas id="canvas"></canvas>
    </div>

    <div class="test-info">
      <h2>Test Status</h2>
      <ul id="test-status"></ul>
    </div>

    <div class="expected-result">
      <h3>Expected Result</h3>
      <p>You should see multiple Fauna entities demonstrating action states and behaviors. Each entity has different actions and visual indicators.</p>
    </div>

    <div class="log" id="log"></div>
  </div>

  <script src="../test-utils.js"></script>
  <script src="../../../engine/dist/engine.js"></script>
  <script>
    const logger = new TestLogger();
    const status = new TestStatus();

    logger.info('Starting Fauna Entity Test');

    class FaunaTestGame extends TEWOU.ActionGame {
      constructor(canvas) {
        super(canvas, 900, 700);
        this.gamename = "fauna-test";
        this.fileextensions = [];
      }

      async load() {
        await super.load();
        logger.success('Game initialized');
      }
    }

    var game;

    // Simple Fauna with idle/active states
    class SimpleFauna extends TEWOU.Fauna {
      constructor(x, y, color) {
        const rect = game.newRectangle(
          { x: 0, y: 0, w: 60, h: 60 },
          color
        );

        const stateText = game.newText("Idle", {
          color: { r: 255, g: 255, b: 255, a: 255 },
          size: 14,
          font: "monospace"
        });
        stateText.rprops.dstrect.x = 10;
        stateText.rprops.dstrect.y = 20;

        super(game.newFrame([rect, stateText]));

        this.pos.x = x;
        this.pos.y = y;
        this.stateText = stateText;

        // Define actions
        this.actions = {
          idle: {
            state: 1, // RunSwitch.off initially
            enabled: () => {
              this.stateText.setText("Idle");
              logger.info(`Fauna at (${Math.round(x)}, ${Math.round(y)}) -> Idle`);
            },
            running: () => {
              // Idle behavior
            }
          },
          active: {
            state: 0, // RunSwitch.off
            enabled: () => {
              this.stateText.setText("Active");
              logger.info(`Fauna at (${Math.round(x)}, ${Math.round(y)}) -> Active`);
            },
            running: () => {
              // Active behavior (e.g., slight movement)
              this.pos.x += Math.sin(Date.now() / 500) * 0.5;
            }
          }
        };

        this.action = "idle";
        this.actionTimer = 0;

        game.registerEntity(this);
      }

      update() {
        super.update();

        // Switch between idle and active every 3 seconds
        this.actionTimer++;
        if (this.actionTimer > 180) { // ~3 seconds at 60fps
          this.actionTimer = 0;
          if (this.action === "idle") {
            this.switchAction("active");
          } else {
            this.switchAction("idle");
          }
        }
      }
    }

    // Fauna with timed actions
    class TimedFauna extends TEWOU.Fauna {
      constructor(x, y) {
        const rect = game.newRectangle(
          { x: 0, y: 0, w: 80, h: 80 },
          { r: 100, g: 200, b: 255, a: 255 }
        );

        const label = game.newText("Timed", {
          color: { r: 255, g: 255, b: 255, a: 255 },
          size: 16,
          font: "monospace"
        });
        label.rprops.dstrect.x = 10;
        label.rprops.dstrect.y = 5;

        const timerText = game.newText("0", {
          color: { r: 255, g: 255, b: 0, a: 255 },
          size: 24,
          font: "monospace"
        });
        timerText.rprops.dstrect.x = 25;
        timerText.rprops.dstrect.y = 30;

        super(game.newFrame([rect, label, timerText]));

        this.pos.x = x;
        this.pos.y = y;
        this.timerText = timerText;
        this.counter = 0;

        // Define actions with timeout
        this.actions = {
          counting: {
            state: 1, // Start enabled
            timer: this.addTimeout([120], { // 2 seconds
              triggered: () => {
                this.counter++;
                this.timerText.setText(this.counter.toString());
                logger.info(`Counter incremented to ${this.counter}`);
              }
            }),
            enabled: () => {
              logger.info('Counting action started');
            },
            running: () => {
              // Continuous counting behavior
            }
          }
        };

        this.action = "counting";

        game.registerEntity(this);
      }
    }

    // Patrolling Fauna
    class PatrolFauna extends TEWOU.Fauna {
      constructor(x, y) {
        const rect = game.newRectangle(
          { x: 0, y: 0, w: 50, h: 50 },
          { r: 255, g: 200, b: 100, a: 255 }
        );

        const arrow = game.newText("→", {
          color: { r: 255, g: 255, b: 255, a: 255 },
          size: 32,
          font: "monospace"
        });
        arrow.rprops.dstrect.x = 10;
        arrow.rprops.dstrect.y = 5;

        super(game.newFrame([rect, arrow]));

        this.pos.x = x;
        this.pos.y = y;
        this.arrow = arrow;
        this.startX = x;
        this.direction = 1;

        this.actions = {
          patrol: {
            state: 1, // Enabled
            enabled: () => {
              logger.info('Patrol started');
            },
            running: () => {
              this.pos.x += this.direction * 2;

              if (this.pos.x > this.startX + 150) {
                this.direction = -1;
                this.arrow.setText("←");
              }
              if (this.pos.x < this.startX) {
                this.direction = 1;
                this.arrow.setText("→");
              }
            }
          }
        };

        this.action = "patrol";

        game.registerEntity(this);
      }
    }

    // Initialize game
    game = new FaunaTestGame(document.getElementById('canvas'));
    TEWOU.Engine.start(game).then(() => {
      logger.info('Creating Fauna entities');

      // Create simple fauna
      new SimpleFauna(50, 50, { r: 255, g: 100, b: 100, a: 255 });
      new SimpleFauna(150, 50, { r: 100, g: 255, b: 100, a: 255 });
      new SimpleFauna(250, 50, { r: 100, g: 100, b: 255, a: 255 });

      logger.success('Created 3 simple Fauna with state switching');
      status.addTest('fauna-creation', 'Fauna entity creation');
      status.pass('fauna-creation', '3 Fauna entities created');

      status.addTest('fauna-actions', 'Action state system');
      status.pass('fauna-actions', 'Actions defined with enabled/running callbacks');

      // Create timed fauna
      new TimedFauna(450, 50);
      new TimedFauna(570, 50);

      logger.success('Created 2 timed Fauna with timeout actions');
      status.addTest('fauna-timeout', 'Timeout-based actions');
      status.pass('fauna-timeout', 'Actions with timer triggers');

      // Create patrolling fauna
      new PatrolFauna(50, 200);
      new PatrolFauna(50, 280);
      new PatrolFauna(50, 360);

      logger.success('Created 3 patrolling Fauna');
      status.addTest('fauna-patrol', 'Continuous movement behavior');
      status.pass('fauna-patrol', '3 patrolling entities');

      TEWOU.Engine.games.push(game);
      TEWOU.Engine.mainLoop();

      logger.success('Test running - Fauna entities active');
    }).catch(err => {
      logger.error('Failed to start test: ' + err.message);
      status.fail('fauna-creation', err.message);
    });
  </script>
</body>
</html>
