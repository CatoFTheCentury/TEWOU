<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Transparency Test</title>
  <link rel="stylesheet" href="../test-common.css">
</head>
<body>
  <div class="test-container">
    <div class="test-header">
      <h1>Transparency Test</h1>
      <p>Tests transparent rectangles with various alpha values using <code>game.newRectangle()</code>. Verifies premultiplied alpha blending works correctly.</p>
    </div>

    <div class="canvas-wrapper">
      <canvas id="canvas"></canvas>
    </div>

    <div class="test-info">
      <h2>Test Status</h2>
      <ul id="test-status"></ul>
    </div>

    <div class="expected-result">
      <h3>Expected Result</h3>
      <p>You should see overlapping transparent rectangles with smooth alpha blending. No black outlines or artifacts around edges. Overlapping areas should blend colors correctly.</p>
    </div>

    <div class="log" id="log"></div>
  </div>

  <script src="../test-utils.js"></script>
  <script src="../../../engine/dist/engine.js"></script>
  <script>
    const logger = new TestLogger();
    const status = new TestStatus();

    logger.info('Starting Transparency Test');

    class TransparencyTestGame extends TEWOU.ActionGame {
      constructor(canvas) {
        super(canvas, 800, 600);
        this.gamename = "transparency-test";
        this.fileextensions = [];
      }

      async load() {
        await super.load();
        logger.success('Game initialized');
      }
    }

    var game;

    // Transparent rectangle entity
    class TransparentRect extends TEWOU.Fauna {
      constructor(x, y, w, h, color, label) {
        const rect = game.newRectangle(
          { x: 0, y: 0, w, h },
          color
        );

        const text = game.newText(label, {
          color: { r: 255, g: 255, b: 255, a: 255 },
          size: 12,
          font: "monospace"
        });
        text.rprops.dstrect.x = 5;
        text.rprops.dstrect.y = 5;

        super(game.newFrame([rect, text]));

        this.pos.x = x;
        this.pos.y = y;

        this.actions = {
          idle: {
            state: 1,
            running: () => {}
          }
        };
        this.action = "idle";

        game.registerEntity(this);
      }
    }

    // Initialize game
    game = new TransparencyTestGame(document.getElementById('canvas'));
    TEWOU.Engine.start(game).then(() => {
      logger.info('Creating transparent rectangle tests');

      // Test 1: Varying alpha levels
      new TransparentRect(50, 50, 100, 80, { r: 255, g: 0, b: 0, a: 255 }, "100%");
      new TransparentRect(80, 80, 100, 80, { r: 255, g: 0, b: 0, a: 204 }, "80%");
      new TransparentRect(110, 110, 100, 80, { r: 255, g: 0, b: 0, a: 153 }, "60%");
      new TransparentRect(140, 140, 100, 80, { r: 255, g: 0, b: 0, a: 102 }, "40%");
      new TransparentRect(170, 170, 100, 80, { r: 255, g: 0, b: 0, a: 51 }, "20%");

      logger.success('Created alpha gradient test');
      status.addTest('alpha-gradient', 'Alpha gradient');
      status.pass('alpha-gradient', '5 overlapping rectangles with decreasing alpha');

      // Test 2: Color blending with transparency
      new TransparentRect(300, 50, 120, 120, { r: 255, g: 0, b: 0, a: 128 }, "Red 50%");
      new TransparentRect(360, 50, 120, 120, { r: 0, g: 255, b: 0, a: 128 }, "Green 50%");
      new TransparentRect(330, 110, 120, 120, { r: 0, g: 0, b: 255, a: 128 }, "Blue 50%");

      logger.success('Created RGB blending test');
      status.addTest('rgb-blend', 'RGB color blending');
      status.pass('rgb-blend', '3 colors overlapping with 50% transparency');

      // Test 3: Very low alpha
      new TransparentRect(550, 50, 150, 100, { r: 255, g: 255, b: 0, a: 25 }, "10% Alpha");
      new TransparentRect(570, 70, 150, 100, { r: 255, g: 255, b: 0, a: 13 }, "5% Alpha");

      logger.success('Created low alpha test');
      status.addTest('low-alpha', 'Very low alpha values');
      status.pass('low-alpha', '2 rectangles with 10% and 5% opacity');

      // Test 4: Stacked layers
      for (let i = 0; i < 10; i++) {
        const alpha = 255 - i * 20;
        const offset = i * 8;
        new TransparentRect(
          50 + offset,
          300 + offset,
          120,
          40,
          { r: 100, g: 150, b: 255, a: alpha },
          `Layer ${i + 1}`
        );
      }

      logger.success('Created layered stack test');
      status.addTest('layered-stack', 'Multiple stacked layers');
      status.pass('layered-stack', '10 layers with decreasing alpha');

      // Test 5: Fully transparent (should be invisible)
      new TransparentRect(550, 300, 100, 80, { r: 255, g: 0, b: 0, a: 0 }, "Invisible");

      logger.success('Created fully transparent test');
      status.addTest('fully-transparent', 'Fully transparent rectangle');
      status.pass('fully-transparent', 'Rectangle with alpha=0 (should be invisible)');

      // Test 6: Edge case - single pixel alpha
      new TransparentRect(550, 400, 100, 80, { r: 0, g: 255, b: 0, a: 1 }, "1/255 Alpha");

      logger.success('Created edge case test');
      status.addTest('edge-case', 'Edge case alpha values');
      status.pass('edge-case', 'Rectangle with alpha=1');

      TEWOU.Engine.games.push(game);
      TEWOU.Engine.mainLoop();

      logger.success('Test running - verify smooth transparency blending');
    }).catch(err => {
      logger.error('Failed to start test: ' + err.message);
      status.fail('alpha-gradient', err.message);
    });
  </script>
</body>
</html>
