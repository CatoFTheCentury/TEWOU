(()=>{"use strict";var t,e,s,i,r,a,o,n,l,h,c,x;!function(t){class e{static MAXLAYERS=256;static vbuffer;static Rframebuffer;static framebuffer;static renderbuffer;static gl}t.Info=e,t.GL=class extends e{constructor(t,s){super(),e.gl||(e.gl=(()=>{document.getElementById("canvas").setAttribute("width",t),document.getElementById("canvas").setAttribute("height",s);let e=document.querySelector("#canvas").getContext("webgl2",{premultipliedAlpha:!1});return e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),e})(),e.framebuffer=e.gl.createFramebuffer(),e.Rframebuffer=e.gl.createFramebuffer(),e.renderbuffer=e.gl.createRenderbuffer(),e.vbuffer=e.gl.createBuffer(),e.gl.bindBuffer(e.gl.ARRAY_BUFFER,e.vbuffer),e.gl.bufferData(e.gl.ARRAY_BUFFER,new Float32Array([1,0,0,0,0,1,1,0,0,1,1,1]),e.gl.STATIC_DRAW),e.gl.clearColor(0,.5,0,0),e.gl.bindFramebuffer(e.gl.READ_FRAMEBUFFER,e.Rframebuffer),e.gl.bindFramebuffer(e.gl.DRAW_FRAMEBUFFER,e.framebuffer),e.gl.bindRenderbuffer(e.gl.RENDERBUFFER,e.renderbuffer),e.gl.renderbufferStorage(e.gl.RENDERBUFFER,e.gl.RGBA8,2e3,2e3),e.gl.framebufferRenderbuffer(e.gl.DRAW_FRAMEBUFFER,e.gl.COLOR_ATTACHMENT0,e.gl.RENDERBUFFER,e.renderbuffer),e.gl.readBuffer(e.gl.COLOR_ATTACHMENT0),e.gl.drawBuffers([e.gl.COLOR_ATTACHMENT0]))}static resizeCanvasToDisplaySize(t,e){e=e||1;const s=t.clientWidth*e|0,i=t.clientHeight*e|0;return(t.width!==s||t.height!==i)&&(t.width=s,t.height=i,!0)}}}(t||(t={})),function(t){class e{static lastTick=0;static currTick=0}class s{static firstTick=0;static delta=16;static refresh(){e.currTick=Date.now(),s.delta=Math.min(e.currTick-e.lastTick,160),e.lastTick=e.currTick}static getTick(){return e.currTick}}t.Delta=s,t.Timeout=class{ms;step=0;end;start;cyclic=!1;deletion=!1;paused=!1;trigName;constructor(t,s,i=!1){this.ms=t,this.trigName=s,this.cyclic=i,this.start=e.currTick,t[0]===1/0?this.end=1/0:this.end=e.currTick+t[0]}reset(){this.start=e.currTick,this.end===1/0||(this.end=e.currTick+this.ms[this.step])}restart(){this.paused=!1,this.reset()}pause(){this.paused=!0}getTimeoutTicks(){return e.currTick-this.start}test(){return this.paused?(this.end===1/0||(this.end+=s.delta),{name:this.trigName,state:"paused"}):this.end<=e.currTick?(this.cyclic&&this.step++,this.step>=this.ms.length&&(this.step=0),this.start=e.currTick,this.end!==1/0&&(this.end=e.currTick+this.ms[this.step]),{name:this.trigName,state:"triggered"}):{name:this.trigName,state:"active"}}}}(e||(e={})),function(t){t[t.none=1]="none",t[t.block=2]="block",t[t.hurt=4]="hurt",t[t.interact=8]="interact",t[t.climbable=16]="climbable",t[t.instakill=32]="instakill",t[t.get=64]="get",t[t.all=127]="all"}(s||(s={})),function(t){t[t.none=1]="none",t[t.player=2]="player",t[t.npc=4]="npc",t[t.grid=8]="grid",t[t.interactable=16]="interactable",t[t.all=31]="all"}(i||(i={})),function(t){class i{static pool=[];triggers=[];timeouts=[];constructor(){i.pool.push(this)}finalize(){}resetmovementvector(){}static refresh(){for(let t=0;t<this.pool.length;t++)i.pool[t].update();for(let t=0;t<this.pool.length;t++)i.pool[t].finalize()}static refreshsome(t){for(let e=0;e<t.length;e++)t[e].update();for(let e=0;e<t.length;e++)t[e].finalize()}static resetallmovements(){for(let t of i.pool)t.resetmovementvector()}update(){this.timeouts=this.timeouts.filter(t=>!t.deletion&&(this.triggers.push(t.test()),!0))}destroy(){i.pool.filter(t=>t!=this)}react(t,e){return!1}}t.Alacrity=i;class r extends i{myFrame;collisions=[];hitbox={x:0,y:0,w:0,h:0};activeeffects=[0,0,0,0];pos={x:0,y:0};flip={flipx:!1,flipy:!1};constructor(t){super(),this.myFrame=t,this.myFrame.rprops.pos=this.pos,this.myFrame.rprops.layer=.5,this.myFrame.rprops.flip=this.flip}destroy(){super.destroy(),this.myFrame.rprops.delete=!0}}t.Embodiment=r,t.Mobility=class extends r{movementvector={x:0,y:0};speed=.2;gravity=new Set;finalize(){let t={x:this.movementvector.x*this.speed*e.Delta.delta,y:this.movementvector.y*this.speed*e.Delta.delta};for(let s of this.gravity)t.x+=s.x*s.strength*e.Delta.delta,t.y+=s.y*s.strength*e.Delta.delta;(t.x<0&&!(this.activeeffects[1]&s.block)||t.x>0&&!(this.activeeffects[3]&s.block))&&(this.pos.x+=t.x),(t.y<0&&!(this.activeeffects[0]&s.block)||t.y>0&&!(this.activeeffects[2]&s.block))&&(this.pos.y+=t.y)}resetmovementvector(){this.movementvector={x:0,y:0}}}}(r||(r={}));class u extends t.Info{static createTexture(e){let s=this.createTexToBlitOn(e.width,e.height);return t.Info.gl.bindTexture(t.Info.gl.TEXTURE_2D,s),t.Info.gl.texImage2D(t.Info.gl.TEXTURE_2D,0,t.Info.gl.RGBA,t.Info.gl.RGBA,t.Info.gl.UNSIGNED_BYTE,e),s}static createSprite(e,s,i){const r=t.Info.gl.createFramebuffer();let a=u.createTexToBlitOn(i.w,i.h);return t.Info.gl.bindFramebuffer(t.Info.gl.FRAMEBUFFER,r),t.Info.gl.framebufferTexture2D(t.Info.gl.FRAMEBUFFER,t.Info.gl.COLOR_ATTACHMENT0,t.Info.gl.TEXTURE_2D,s,0),t.Info.gl.bindTexture(t.Info.gl.TEXTURE_2D,a),t.Info.gl.copyTexSubImage2D(t.Info.gl.TEXTURE_2D,0,0,0,i.x,i.y,i.w,i.h),t.Info.gl.deleteFramebuffer(r),a}static createTexToBlitOn(e,s){const i=t.Info.gl.createTexture();return t.Info.gl.bindTexture(t.Info.gl.TEXTURE_2D,i),t.Info.gl.texImage2D(t.Info.gl.TEXTURE_2D,0,t.Info.gl.RGBA,e,s,0,t.Info.gl.RGBA,t.Info.gl.UNSIGNED_BYTE,null),t.Info.gl.texParameteri(t.Info.gl.TEXTURE_2D,t.Info.gl.TEXTURE_MIN_FILTER,t.Info.gl.NEAREST),t.Info.gl.texParameteri(t.Info.gl.TEXTURE_2D,t.Info.gl.TEXTURE_MAG_FILTER,t.Info.gl.NEAREST),t.Info.gl.texParameteri(t.Info.gl.TEXTURE_2D,t.Info.gl.TEXTURE_WRAP_S,t.Info.gl.CLAMP_TO_EDGE),t.Info.gl.texParameteri(t.Info.gl.TEXTURE_2D,t.Info.gl.TEXTURE_WRAP_T,t.Info.gl.CLAMP_TO_EDGE),i}static nextPowerOfTwo(t){return 2==t||4==t||8==t||16==t||32==t||64==t||128==t||256==t||512==t||1024==t||2048==t?t:t>2048?2048:t<=0?1:(t--,t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,1+(t|=t>>16))}}class d{static parser=new DOMParser;static textures={};static texts={};static sounds={};static imgExts=["png","jpg","gif","jpeg"];static txtExts=["nw","txt","vert","frag","gani","csv"];static sndExts=["wav","mp3"];static audioContext;static placeholder="_assets/blocking.png";static getTexture(t){return d.textures[t]?d.textures[t].t:(console.log("Texture file not found or not loaded : "+t),d.textures[this.placeholder])}static getTextureWidth(t){return d.textures[t]?d.textures[t].w:(console.log("Texture file not found or not loaded : "+t),-1)}static getTextureHeight(t){return d.textures[t]?d.textures[t].h:(console.log("Texture file not found or not loaded : "+t),-1)}static getText(t){return d.texts[t]?d.texts[t]:(console.log("Text file not found or not loaded : "+t),"")}static initAudio(){d.audioContext=new window.AudioContext}static addTexture(t,e,s){d.textures[t]={t:e,...s}}static async addImage(t){if(!d.textures[t]){let e=new Image;e.src=t,await e.decode().then(()=>{d.textures[t]={t:u.createTexture(e),w:e.width,h:e.height}})}return t}static async addText(t){return d.texts[t]||(d.texts[t]=await fetch(t).then(t=>t.text())),t}static async addSound(t){return d.sounds[t]||await fetch(t).then(t=>t.arrayBuffer()).then(t=>d.audioContext.decodeAudioData(t)).then(e=>{d.sounds[t]=e}).catch(t=>console.error("Error loading audio file:",t)),t}static playSound(t){d.sounds[t]?d.play(d.sounds[t]):d.addSound(t).then(t=>d.play(d.sounds[t]))}static play(t){let e=d.audioContext.createBufferSource();e.buffer=t,e.connect(d.audioContext.destination),e.start()}static async loadAllExtInFolder(t,e){let s=new XMLHttpRequest,i=[];return s.open("GET",t,!1),s.onreadystatechange=function(){if(4===s.readyState&&200===s.status){let r=d.parser.parseFromString(s.responseText,"text/html").getElementsByTagName("a"),a=[];for(let t=0;t<r.length;t++)a.push(r[t].getAttribute("href"));for(let s of a){if(s.trim().length<=0)continue;let r=s.split("."),a=r[r.length-1];a.endsWith("/")||a.startsWith("?")||(e.includes(a)?d.imgExts.includes(a)?i.push(d.addImage(t+s)):d.txtExts.includes(a)?i.push(d.addText(t+s)):d.sndExts.includes(a)?i.push(d.addSound(t+s)):console.log("Incompatible file : "+s):console.log("File is neither "+e.join(" or ")+" : "+s))}}},s.send(),await Promise.all(i),i}}class y extends t.Info{static shaders={};static fallbackShader="normal";static previousShader="";static currShader;static getShader(t=""){let e=y.shaders[t]||y.shaders[y.fallbackShader]||void 0;return void 0===e&&console.log("Shader "+t+" doesn't exist and couldn't find fallback shader "+y.fallbackShader),e}static compileShader(t,e){let s=y.gl.createShader(t);return y.gl.shaderSource(s,e),y.gl.compileShader(s),y.gl.getShaderParameter(s,y.gl.COMPILE_STATUS)?s:(console.debug(y.gl.getShaderInfoLog(s)),y.gl.deleteShader(s),null)}static createProgram(t,e){let s=y.gl.createProgram();return y.gl.attachShader(s,t),y.gl.attachShader(s,e),y.gl.linkProgram(s),y.gl.getProgramParameter(s,y.gl.LINK_STATUS)?s:(console.debug(y.gl.getProgramInfoLog(s)),y.gl.deleteProgram(s),null)}static passShader(t,e){if(null!=t.rprops.shaderID?y.validateShader(t.rprops.shaderID):y.validateShader(this.fallbackShader),null!=y.currShader){for(const t of y.currShader.second)t();for(const s of y.currShader.passes)s(t,e)}}static validateShader(t){y.previousShader!==t&&(y.currShader=y.shaders[t],null!=y.currShader?(y.initShader(y.currShader),y.previousShader=t):(y.currShader=y.shaders[this.fallbackShader]||void 0,null!=y.currShader?y.initShader(y.currShader):console.log("Fallback shader undefined"),y.previousShader=this.fallbackShader))}static initShader(e){t.Info.gl.useProgram(e.program);for(const t of y.currShader.first)t()}}class p extends t.Info{static frm;static refresh(){var t=y.gl;p.frm.compose(),t.bindFramebuffer(t.FRAMEBUFFER,null),t.viewport(0,0,t.canvas.width,t.canvas.height),t.clear(t.COLOR_BUFFER_BIT),t.bindTexture(t.TEXTURE_2D,p.frm.texture),y.passShader(p.frm,{w:t.canvas.width,h:t.canvas.height}),t.drawArrays(t.TRIANGLES,0,6)}}!function(e){class s extends t.Info{rprops;texture;file;ready;constructor(){super(),this.rprops={srcrect:void 0,dstrect:{x:0,y:0,w:0,h:0},pos:{x:0,y:0},flip:{flipx:!1,flipy:!1},angle:0,scalex:1,scaley:1,layer:0,hidden:!1,delete:!1}}}e.Renderable=s;class i extends s{constructor(t,e,s,i=void 0){super(),this.file=t,this.rprops.srcrect=e,this.rprops.dstrect=s}compose(){if(this.ready&&(i.gl.deleteTexture(this.texture),this.ready=!1),!this.ready){let e=u.createTexToBlitOn(this.rprops.srcrect.w,this.rprops.srcrect.h);u.gl.bindFramebuffer(u.gl.FRAMEBUFFER,t.Info.framebuffer),u.gl.framebufferTexture2D(u.gl.FRAMEBUFFER,u.gl.COLOR_ATTACHMENT0,u.gl.TEXTURE_2D,d.getTexture(this.file),0),u.gl.bindTexture(u.gl.TEXTURE_2D,e),u.gl.copyTexSubImage2D(u.gl.TEXTURE_2D,0,0,0,this.rprops.srcrect.x,this.rprops.srcrect.y,this.rprops.srcrect.w,this.rprops.srcrect.h),u.gl.bindFramebuffer(u.gl.FRAMEBUFFER,null),this.texture=e}}}e.Image=i;class r extends s{remove;dynamic=!1;bg;mask;viewport;applyBg(){}applyMask(){}compose(){return this.rprops.delete}constructor(){super(),this.viewport={x:0,y:0,w:r.gl.canvas.width,h:r.gl.canvas.height}}static createFocus(t){return{x:t.reduce((t,e)=>Math.min(t,e.rprops.dstrect.x),t[0].rprops.dstrect.x),y:t.reduce((t,e)=>Math.min(t,e.rprops.dstrect.y),t[0].rprops.dstrect.y),w:t.reduce((t,e)=>Math.max(t,e.rprops.dstrect.w+e.rprops.dstrect.x),0),h:t.reduce((t,e)=>Math.max(t,e.rprops.dstrect.h+e.rprops.dstrect.y),0)}}generateComposite(t,e){let s=t.filter(t=>!t?.rprops.hidden);if(s.length>0){s.sort((t,e)=>t.rprops.layer-e.rprops.layer);for(let t=0;t<s.length;t++)s[t].compose();this.rprops.srcrect={x:e.x,y:e.y,w:e.w<=this.rprops.dstrect.w?this.rprops.dstrect.w:e.w,h:e.h<=this.rprops.dstrect.h?this.rprops.dstrect.h:e.h},this.rprops.dstrect={x:this.rprops.pos.x,y:this.rprops.pos.y,w:this.rprops.srcrect.w,h:this.rprops.srcrect.h};let t=a.gl;t.bindFramebuffer(t.FRAMEBUFFER,r.framebuffer),this.texture=u.createTexToBlitOn(this.rprops.dstrect.w,this.rprops.dstrect.h),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.texture,0),t.viewport(this.viewport.x,this.viewport.y,this.rprops.dstrect.w,this.rprops.dstrect.h);for(let e=0;e<s.length;e++)y.gl.bindTexture(t.TEXTURE_2D,s[e].texture),y.passShader(s[e],this.rprops.dstrect),t.drawArrays(t.TRIANGLES,0,6);this.ready=!0}else this.ready=!1}}class a extends r{parts;constructor(t){super(),this.parts=t}compose(){if(this.rprops.delete)return this.rprops.delete;if(this.dynamic&&(this.ready&&r.gl.deleteTexture(this.texture),this.ready=!1),!this.ready){let t=a.createFocus(this.parts);this.generateComposite(this.parts,t)}return this.rprops.delete}}e.Snap=a,e.Animation=class extends r{frames;currentFrame=0;constructor(t){super(),this.dynamic=!0,this.frames=t}compose(){return this.rprops.delete||(!this.frames[this.currentFrame].dynamic&&this.frames[this.currentFrame].ready||this.frames[this.currentFrame].compose(),this.texture=this.frames[this.currentFrame].texture,this.rprops=this.frames[this.currentFrame].rprops,this.ready=this.frames[this.currentFrame].ready),this.rprops.delete}},e.Frame=class extends r{frame;camera=void 0;constructor(t,e={w:0,h:0}){super(),this.frame=t,this.dynamic=!0,this.rprops.dstrect.w=e.w,this.rprops.dstrect.h=e.h}compose(){if(void 0===this.frame[0])return console.log("Skipping empty frame..."),!0;if((this.dynamic||this.rprops.delete)&&((this.ready||this.rprops.delete)&&r.gl.deleteTexture(this.texture),this.ready=!1),!this.ready){this.frame=this.frame.filter(t=>null!=t&&!t.compose());let t=this.frame.filter(t=>t.ready),e=a.createFocus(t);this.rprops.dstrect.x=this.rprops.pos.x,this.rprops.dstrect.y=this.rprops.pos.y,void 0!==this.camera&&(this.rprops.dstrect.w=this.camera.viewport.w,this.rprops.dstrect.h=this.camera.viewport.h,this.viewport={x:-this.camera.viewport.x,y:-this.camera.viewport.y,w:this.camera.viewport.w,h:this.camera.viewport.h}),t.length>0&&this.generateComposite(t,e)}return this.rprops.delete}}}(a||(a={}));class m{static init=!1;static keys={};constructor(){m.init||(document.addEventListener("keydown",t=>{t.repeat||(m.keys[t.key]=1)}),document.addEventListener("keyup",t=>{m.keys[t.key]=-1})),m.init=!0}static refresh(){for(let t in m.keys)m.keys[t]=m.keys[t]<0?0:m.keys[t]>0?2:0}}!function(t){let e,s;!function(t){t[t.idle=0]="idle",t[t.walk=1]="walk",t[t.climb=2]="climb",t[t.attack=3]="attack",t[t.jump=4]="jump",t[t.dead=5]="dead",t[t.length=6]="length"}(e||(e={})),function(t){t[t.grayguy=0]="grayguy",t[t.graygirl=1]="graygirl",t[t.greenimp=2]="greenimp",t[t.reddemon=3]="reddemon",t[t.greenzombie=4]="greenzombie",t[t.skull=5]="skull",t[t.ghost=6]="ghost",t[t.redguy=7]="redguy",t[t.redgirl=8]="redgirl",t[t.blueimp=9]="blueimp",t[t.graydemon=10]="graydemon",t[t.redzombie=11]="redzombie",t[t.redskull=12]="redskull",t[t.redghost=13]="redghost",t[t.blueguy=14]="blueguy",t[t.bluegirl=15]="bluegirl",t[t.dwarf=16]="dwarf",t[t.bluedemon=17]="bluedemon",t[t.bluezombie=18]="bluezombie",t[t.yellowskull=19]="yellowskull",t[t.blueghost=20]="blueghost",t[t.length=21]="length"}(s=t.FullChar||(t.FullChar={}));class i{static scorpions={red:0,black:1,green:2,count:3};static fullscorpions=[];constructor(){if(i.fullscorpions.length<=0)for(let t=0;t<i.scorpions.count;t++){let e={x:16*(26+6*t),y:160};i.fullscorpions.push([new a.Animation([new a.Snap([new a.Image("_assets/demon/tileset_16x16_5A5268.png",{x:e.x,y:e.y,w:16,h:16},{x:0,y:0,w:16,h:16})])]),new a.Animation([new a.Snap([new a.Image("_assets/demon/tileset_16x16_5A5268.png",{x:e.x+16,y:e.y,w:16,h:16},{x:0,y:0,w:16,h:16})]),new a.Snap([new a.Image("_assets/demon/tileset_16x16_5A5268.png",{x:e.x+32,y:e.y,w:16,h:16},{x:0,y:0,w:16,h:16})])]),new a.Animation([new a.Snap([new a.Image("_assets/demon/tileset_16x16_5A5268.png",{x:e.x+48,y:e.y,w:16,h:16},{x:0,y:0,w:16,h:16})])]),new a.Animation([new a.Snap([new a.Image("_assets/demon/tileset_16x16_5A5268.png",{x:e.x+32,y:e.y,w:16,h:16},{x:0,y:0,w:16,h:16})]),new a.Snap([new a.Image("_assets/demon/tileset_16x16_5A5268.png",{x:e.x+64,y:e.y,w:16,h:16},{x:0,y:0,w:16,h:16})])]),new a.Animation([new a.Snap([new a.Image("_assets/demon/tileset_16x16_5A5268.png",{x:e.x+16,y:e.y,w:16,h:16},{x:0,y:0,w:16,h:16})])]),new a.Animation([new a.Snap([new a.Image("_assets/demon/tileset_16x16_5A5268.png",{x:e.x+80,y:e.y,w:16,h:16},{x:0,y:0,w:16,h:16})])])])}}}t.ScorpionAnimations=i;class r{static fullCharacters=[];static buildCharacter(t){let e={x:16*(26+6*Math.floor(t/7)),y:16*(1+t%7)};return[new a.Animation([new a.Snap([new a.Image("_assets/demon/tileset_16x16_5A5268.png",{x:e.x,y:e.y,w:16,h:16},{x:0,y:0,w:16,h:16})])]),new a.Animation([new a.Snap([new a.Image("_assets/demon/tileset_16x16_5A5268.png",{x:e.x+16,y:e.y,w:16,h:16},{x:0,y:0,w:16,h:16})]),new a.Snap([new a.Image("_assets/demon/tileset_16x16_5A5268.png",{x:e.x+32,y:e.y,w:16,h:16},{x:0,y:0,w:16,h:16})])]),new a.Animation([new a.Snap([new a.Image("_assets/demon/tileset_16x16_5A5268.png",{x:e.x+48,y:e.y,w:16,h:16},{x:0,y:0,w:16,h:16})])]),new a.Animation([new a.Snap([new a.Image("_assets/demon/tileset_16x16_5A5268.png",{x:e.x+32,y:e.y,w:16,h:16},{x:0,y:0,w:16,h:16})]),new a.Snap([new a.Image("_assets/demon/tileset_16x16_5A5268.png",{x:e.x+64,y:e.y,w:16,h:16},{x:0,y:0,w:16,h:16})])]),new a.Animation([new a.Snap([new a.Image("_assets/demon/tileset_16x16_5A5268.png",{x:e.x+16,y:e.y,w:16,h:16},{x:0,y:0,w:16,h:16})])]),new a.Animation([new a.Snap([new a.Image("_assets/demon/tileset_16x16_5A5268.png",{x:e.x+80,y:e.y,w:16,h:16},{x:0,y:0,w:16,h:16})])])]}constructor(){if(0==r.fullCharacters.length){let t={w:3,h:7};for(let e=0;e<t.w;e++)for(let s=0;s<t.h;s++){let t={x:16*(26+6*e),y:16*(1+s)};r.fullCharacters.push([new a.Animation([new a.Snap([new a.Image("_assets/demon/tileset_16x16_5A5268.png",{x:t.x,y:t.y,w:16,h:16},{x:0,y:0,w:16,h:16})])]),new a.Animation([new a.Snap([new a.Image("_assets/demon/tileset_16x16_5A5268.png",{x:t.x+16,y:t.y,w:16,h:16},{x:0,y:0,w:16,h:16})]),new a.Snap([new a.Image("_assets/demon/tileset_16x16_5A5268.png",{x:t.x+32,y:t.y,w:16,h:16},{x:0,y:0,w:16,h:16})])]),new a.Animation([new a.Snap([new a.Image("_assets/demon/tileset_16x16_5A5268.png",{x:t.x+48,y:t.y,w:16,h:16},{x:0,y:0,w:16,h:16})])]),new a.Animation([new a.Snap([new a.Image("_assets/demon/tileset_16x16_5A5268.png",{x:t.x+32,y:t.y,w:16,h:16},{x:0,y:0,w:16,h:16})]),new a.Snap([new a.Image("_assets/demon/tileset_16x16_5A5268.png",{x:t.x+64,y:t.y,w:16,h:16},{x:0,y:0,w:16,h:16})])]),new a.Animation([new a.Snap([new a.Image("_assets/demon/tileset_16x16_5A5268.png",{x:t.x+16,y:t.y,w:16,h:16},{x:0,y:0,w:16,h:16})])]),new a.Animation([new a.Snap([new a.Image("_assets/demon/tileset_16x16_5A5268.png",{x:t.x+80,y:t.y,w:16,h:16},{x:0,y:0,w:16,h:16})])])])}}}}t.CharacterAnimations=r}(o||(o={}));class g{static view;static clickables=[];static clicked=[];static touches=[];static init=!1;constructor(){if(!g.init){let t=document.getElementById("canvas");g.view={w:t.clientWidth,h:t.clientHeight};for(let t=0;t<4;t++)g.touches.push({state:0,pos:{x:0,y:0},start:{x:0,y:0},timer:new e.Timeout([1/0],"time")});document.addEventListener("touchstart",t=>{for(let s=0;s<Math.min(t.changedTouches.length,4);s++){console.log(t.changedTouches[s].identifier),g.touches[t.changedTouches[s].identifier]={state:1,pos:{x:t.changedTouches[s].clientX,y:t.changedTouches[s].clientY},start:{x:t.changedTouches[s].clientX,y:t.changedTouches[s].clientY},timer:new e.Timeout([1/0],"time")};for(let e of g.clickables)g.inBounds(g.touches[t.changedTouches[s].identifier].pos.x,g.touches[t.changedTouches[s].identifier].pos.y,e.bounds)&&e.callback()}}),document.addEventListener("touchend",t=>{t.preventDefault();for(let e=0;e<t.changedTouches.length;e++)g.touches[t.changedTouches[e].identifier].state=-1;g.clicked=[]}),document.addEventListener("touchmove",t=>{t.preventDefault();for(let e=0;e<t.changedTouches.length;e++)g.touches[t.changedTouches[e].identifier].pos={x:t.changedTouches[e].clientX,y:t.changedTouches[e].clientY}})}g.init=!0}static refresh(){for(let t in g.touches)g.touches[t].state=g.touches[t].state<0?0:g.touches[t].state>0?2:0}static addButton(t,e,s){g.clickables.push({name:t,bounds:e,callback:s})}static inBounds(t,e,s){return t>s.x&&t<s.x+s.w&&e>s.y&&e<s.y+s.h}}!function(t){let s;!function(t){t[t.idle=0]="idle",t[t.walk=1]="walk",t[t.climb=2]="climb",t[t.attack=3]="attack",t[t.jump=4]="jump",t[t.dead=5]="dead",t[t.count=6]="count"}(s=t.AniSt||(t.AniSt={}));class i extends r.Mobility{state=s.idle;myCamera;anims;changeframe=new e.Timeout([200],"changeframe");currentAnim;normalgravity={strength:.05,x:0,y:1};constructor(t){super(t),this.changeframe.paused=!0,this.timeouts.push(this.changeframe)}}t.Incarnated=i;class a extends i{}t.Fauna=a,t.Player=class extends a{allstates=(1<<s.count)-1}}(n||(n={}));class f{static pool=[];constructor(t=!1){t?f.pool.unshift(this):f.pool.push(this)}static refresh(){for(let t=0;t<this.pool.length;t++)f.pool[t].refresh()}}class w extends f{static collisionpool=[];constructor(){super()}refresh(){w.collisionpool=w.collisionpool.filter(t=>!t.deleteMe);let t=w.collisionpool.filter(t=>null!=t.self||null==t.self);for(let e of t)e.self&&(e.self.activeeffects=[s.none,s.none,s.none,s.none]);t.forEach(e=>{let s=new Set(t.filter(t=>t.from&e.to&&t.self).map(t=>t.self));e.self&&s.delete(e.self),e.update(s)})}addCollisionTo(t,e){return w.collisionpool.push(e),null!=t&&(t.collisions.push(e),e.self=t),e}}class b{deleteMe=!1;from;to;type;self;offY;offX;width;height;ogBounds={x:0,y:0,w:0,h:0};padding={x:1,y:1};constructor(t,e,s){this.from=t,this.to=e,this.type=s}update(t){for(let e of t)this.intersect(e)}static inBounds(t,e,s){return t>s.x&&t<s.x+s.w&&e>s.y&&e<s.y+s.h}computeCollidePoints(t,e={x:1,y:1},s={w:1,h:1},i=0){let r=[[Math.max(0,Math.floor((t.x+2*e.x)/s.w))>>>i,Math.max(0,Math.floor(t.x/s.w))>>>i,Math.max(0,Math.floor((t.x+t.w-2*e.x)/s.w))>>>i,Math.max(0,Math.floor((t.x+t.w)/s.w))>>>i],[Math.max(0,Math.floor((t.y+2*e.y)/s.h)),Math.max(0,Math.floor(t.y/s.h)),Math.max(0,Math.floor((t.y+t.h-2*e.y)/s.h)),Math.max(0,Math.floor((t.y+t.h)/s.h))]];return[[[r[0][0],r[0][2]],[r[1][1],r[1][1]]],[[r[0][1],r[0][1]],[r[1][0],r[1][2]]],[[r[0][0],r[0][2]],[r[1][3],r[1][3]]],[[r[0][3],r[0][3]],[r[1][0],r[1][2]]]]}}class T extends b{constructor(t,e,s,i){super(e,s,i),this.self=t,this.padding={x:8,y:8}}intersect(t){const e={x:t.pos.x+t.hitbox.x,y:t.pos.y+t.hitbox.y,w:t.hitbox.w,h:t.hitbox.h},i=(this.computeCollidePoints(e,this.padding),this.self.pos.x+this.self.hitbox.x),r=this.self.pos.y+this.self.hitbox.y,a=this.self.hitbox.w,o=this.self.hitbox.h;let n=[s.none,s.none,s.none,s.none];(e.x>i&&e.x+this.padding.x<i+a||e.x+e.w-this.padding.x>i&&e.x+e.w<i+a)&&(n[0]|=r+o-e.y>0&&e.y>r?this.type:s.none,n[2]|=r-(e.y+e.h)<0&&e.y+e.h<r+o?this.type:s.none),(e.y>r&&e.y+this.padding.y<r+o||e.y+e.w-this.padding.y>r&&e.y+e.w<r+o)&&(n[1]|=i+a-e.x>0&&e.x>i?this.type:s.none,n[3]|=i-(e.x+e.w)<0&&e.x+e.w<i+a?this.type:s.none);for(let e=0;e<4;e++)t.activeeffects[e]|=n[e]}static checkBounds(t,e){return b.inBounds(t[0][0],t[1][0],e)||b.inBounds(t[0][1],t[1][1],e)}}!function(t){t[t.idle=0]="idle",t[t.walk=1]="walk",t[t.climb=2]="climb",t[t.attack=3]="attack",t[t.jump=4]="jump",t[t.dead=5]="dead"}(l||(l={}));class A extends n.Player{jumpend;normalgravity={strength:.05,x:0,y:1};jumpgravity={strength:.1,x:0,y:-1};lifetime=new e.Timeout([1/0],"lifetime");isghost=!1;stoptimer=0;timer;uielt;inventory={keys:0};constructor(){let t=o.CharacterAnimations.fullCharacters[o.FullChar.skull];super(new a.Frame([t[l.idle].frames[0]])),this.anims=t,this.currentAnim=t[l.idle],this.changeframe=new e.Timeout([150],"changeframe"),this.changeframe.paused=!0,this.timeouts.push(this.changeframe),this.jumpend=new e.Timeout([700],"jumpend"),this.jumpend.paused=!0,this.timeouts.push(this.jumpend),w.collisionpool.push(new T(this,i.player,i.grid|i.npc|i.interactable,s.block)),this.gravity.add(this.normalgravity),this.speed=.075,this.hitbox={x:1,y:2,w:14,h:14},this.flip.flipx=!1,this.pos.x=168,this.pos.y=200}update(){if(super.update(),this.timer||(this.uielt.style.textAlign="left",this.uielt.style.background="red",this.timer=new e.Timeout([1/0],"timer")),0==this.stoptimer){let t=Math.round(this.timer.getTimeoutTicks()/100)/10;this.uielt.innerHTML=t+(t%1==0?".0":"")}this.lifetime.getTimeoutTicks()>500&&this.state==l.walk&&!this.isghost?(d.playSound("_assets/demon/footstep.wav"),this.lifetime.reset()):this.lifetime.getTimeoutTicks()>1e3&&this.state==l.walk&&(d.playSound("_assets/demon/hoverghost.wav"),this.lifetime.reset()),this.state==l.jump&&this.activeeffects[0]&s.block&&this.stopjump(),this.handleKeys(),this.handleTriggers(),this.handleTouch()}react(t,e){switch(t){case"healthup":break;case"becomeghost":this.anims=o.CharacterAnimations.fullCharacters[o.FullChar.ghost],this.isghost=!0;break;case"getkey":this.inventory.keys+=e[0];break;case"usekey":if(this.inventory.keys>0)return d.playSound("_assets/demon/unlock.wav"),this.inventory.keys--,e[0].myCollision.deleteMe=!0,e[0].destroy(),!0;break;case"stoptimer":this.stoptimer=Math.round(this.timer.getTimeoutTicks()/100)/10,this.uielt.innerHTML=this.stoptimer+(this.stoptimer%1==0?".0":""),this.uielt.style.background="green"}return console.log("woops"),!1}handleTouch(){let t=0;for(let e of g.touches)void 0!==e&&void 0!==e.state&&e.state>0&&t++;for(let e=0;e<g.touches.length;e++){let i=g.touches[e];if(void 0!==i)switch(i.state){case-1:console.log("FAS)"),i.timer.getTimeoutTicks()<500&&i.start.y-i.pos.y>20&&this.activeeffects[2]&s.block&&this.state!=l.jump&&(100*Math.random()>50?d.playSound("_assets/demon/boing1.wav"):d.playSound("_assets/demon/boing2.wav"),this.gravity.add(this.jumpgravity),this.jumpend.reset(),this.jumpend.paused=!1,this.state=l.jump,this.myFrame.frame=[this.anims[this.state]]);break;case 0:0==t&&this.state!=l.jump&&(this.state=l.idle,this.myFrame.frame=[this.anims[this.state]],this.changeframe.paused=!0);break;case 1:this.changeframe.paused=!1;break;case 2:if(0===e||1==t){let t=this.myCamera.worldtoscreen(this);this.movementvector={x:Math.min(3,2/(g.view.w/i.pos.x)-8/(g.view.w/t.x)),y:0},this.flip.flipx=!(this.movementvector.x>0),this.state=l.walk,this.myFrame.frame=[this.anims[this.state]]}this.currentAnim=this.anims[this.state]}}}handleKeys(){for(let t in m.keys)switch(t){case"ArrowUp":m.keys.ArrowUp;break;case"ArrowLeft":switch(m.keys.ArrowLeft){case-1:this.state!=l.jump&&(this.state=l.idle),this.state=l.idle,this.currentAnim.currentFrame=0,this.myFrame.frame=[this.anims[this.state]],this.changeframe.paused=!0;case 0:break;case 2:case 1:this.state!=l.jump&&(this.state=l.walk),this.flip.flipx=!0,this.myFrame.frame=[this.anims[this.state]],this.currentAnim=this.anims[this.state],this.changeframe.paused=!1,this.movementvector.x=-1}break;case"ArrowDown":m.keys.ArrowDown;break;case"ArrowRight":switch(m.keys.ArrowRight){case-1:this.state!=l.jump&&(this.state=l.idle),this.currentAnim.currentFrame=0,this.myFrame.frame=[this.anims[this.state]],this.changeframe.paused=!0;case 0:break;case 2:case 1:this.state!=l.jump&&(this.state=l.walk),this.flip.flipx=!1,this.myFrame.frame=[this.anims[this.state]],this.currentAnim=this.anims[this.state],this.changeframe.paused=!1,this.movementvector.x=1}break;case" ":switch(m.keys[" "]){case-1:case 0:case 2:break;case 1:console.log("Player x: "+this.pos.x+", Player y: "+this.pos.y),this.activeeffects[2]&s.block&&this.state!=l.jump&&(100*Math.random()>50?d.playSound("_assets/demon/boing1.wav"):d.playSound("_assets/demon/boing2.wav"),this.gravity.add(this.jumpgravity),this.jumpend.reset(),this.jumpend.paused=!1,this.state=l.jump,this.myFrame.frame=[this.anims[this.state]])}}}handleTriggers(){for(;this.triggers.length>0;){let t=this.triggers.pop()||{name:"notrigger"};switch(t.name){case"changeframe":"triggered"===t.state&&(this.currentAnim.currentFrame=(this.currentAnim.currentFrame+1)%this.currentAnim.frames.length);break;case"jumpend":"triggered"===t.state&&this.stopjump();break;case"healthup":console.log("Health up by"+t.state)}}}stopjump(){this.gravity.delete(this.jumpgravity),this.jumpend.paused=!0,this.state=l.idle,this.myFrame.frame=[this.anims[this.state]]}}class k{static loadCSV(t){return{tileYX:t.split("\n").filter(t=>""!=t).map(t=>t.split(",").map(t=>Number(t)))}}static async loadIni(t){let e,s,i,r,a=[],o="",n=[];const l=d.getText(await d.addText(t)).split("\n");for(let t=0;t<l.length;t++){const h=l[t].split(" ");switch(h[0]){case"TILESET":const t=h[1].split(":");switch(t[0]){case"SQUARE":i={w:Number(t[1]),h:Number(t[1])};break;case"FILE":e=d.getTexture(await d.addImage(t[1])),s=d.getTextureWidth(t[1])}break;case"PLAYGROUND":r=Number(h[1]);break;case"CSV":let l=h[1].split(":");const c=d.getText(await d.addText(l[1]));a[Number(l[0])]={tileYX:c.split("\n").filter(t=>""!=t).map(t=>t.split(",").map(t=>Number(t)))};break;case"NPCS":o=d.getText(await d.addText(h[1]));break;case"COLLISION":const x=d.getText(await d.addText(h[1])).split("\n");let u=[];for(let t of x)u.push(t.split(",").map(t=>!(Number(t)<0)));n=u}}return{tiles:a,npcs:o,collisions:n,tileset:e,tilesetwidth:s,square:i,playLayer:r,grid:{w:a[0].tileYX[0].length,h:a[0].tileYX.length}}}}class v extends t.Info{static blit(t,e){let s=-1;return t.tiles.map(i=>{s++,v.gl.createFramebuffer(),v.gl.bindFramebuffer(v.gl.FRAMEBUFFER,v.framebuffer);const r=t.square.w*i.tileYX[0].length,o=t.square.h*i.tileYX.length,n=t.tilesetwidth/t.square.w;let l=u.createTexToBlitOn(r,o);v.gl.framebufferTexture2D(v.gl.FRAMEBUFFER,v.gl.COLOR_ATTACHMENT0,v.gl.TEXTURE_2D,t.tileset,0),v.gl.bindTexture(v.gl.TEXTURE_2D,l);for(let e=0;e<i.tileYX.length;e++)for(let s=0;s<i.tileYX[e].length;s++)v.gl.copyTexSubImage2D(v.gl.TEXTURE_2D,0,s*t.square.w,e*t.square.h,i.tileYX[e][s]%n*t.square.w,Math.floor(i.tileYX[e][s]/n)*t.square.h,t.square.w,t.square.h);d.addTexture(e+s,l,{w:r,h:o});let h=new a.Image(e+s,{x:0,y:0,w:r,h:o},{x:0,y:0,w:r,h:o}),c=new a.Snap([h]);return c.rprops.layer=s-t.playLayer,c})}}class E extends f{viewport;bounds;actor;constructor(t,e,s){super(),this.actor=t,this.viewport={x:0,y:0,w:e.w,h:e.h},this.bounds=s}refresh(){this.viewport.x=this.actor.pos.x-this.viewport.w/2+this.actor.hitbox.w/2+this.actor.hitbox.x>this.bounds.x?this.actor.pos.x+this.viewport.w/2+this.actor.hitbox.w/2+this.actor.hitbox.x>this.bounds.w?this.bounds.w-this.viewport.w:Math.floor(this.actor.pos.x-this.viewport.w/2+this.actor.hitbox.w/2+this.actor.hitbox.x):this.bounds.x,this.viewport.y=this.actor.pos.y-this.viewport.h/2+this.actor.hitbox.h/2+this.actor.hitbox.y>this.bounds.y?this.actor.pos.y+this.viewport.h/2+this.actor.hitbox.h/2+this.actor.hitbox.y>this.bounds.h?this.bounds.h-this.viewport.h:Math.floor(this.actor.pos.y-this.viewport.h/2+this.actor.hitbox.h/2+this.actor.hitbox.y):this.bounds.y}worldtoscreen(t){return{x:t.pos.x-this.viewport.x,y:t.pos.y-this.viewport.y}}}class _ extends b{padding={x:2,y:2};resolution=16;walls=[];static sizeBit=5;static bitSize=1<<this.sizeBit;ylimit;xlimit;constructor(t,e,s,r){super(i.grid,s,r),this.ylimit=t.length;let a=t[0].length;this.xlimit=a>>_.sizeBit;let o=t.flat(1/0),n=0;this.resolution=e;for(let t=0;t<o.length;t+=a){this.walls.push(Array());for(let e=0;e<a;e+=_.bitSize){let s=0;for(let i=0;i<_.bitSize&&!(e+i>=a);i++)1==o[t+e+i]&&(s|=1<<i);this.walls[n].push(s)}n+=1}}againstGrid(t,e,s){let i=t,r=e;if(r>=this.ylimit||r<0)return!1;let a=1<<Math.floor(s/this.resolution)%_.bitSize;return!(i>=this.xlimit||i<0)&&0!=(this.walls[r][i]&a)}testWall(t){return this.againstGrid(Math.floor(t.x/this.resolution)>>>_.sizeBit,Math.floor(t.y/this.resolution),t.x)}intersect(t){const e=this.computeCollidePoints({x:t.pos.x+t.hitbox.x,y:t.pos.y+t.hitbox.y,w:t.hitbox.w,h:t.hitbox.h},this.padding,{w:this.resolution,h:this.resolution},_.sizeBit);this.checkCollisionDirection(t,0,e[0][0][0],e[0][1][0],t.pos.x+t.hitbox.x+2*this.padding.x,e[0][0][1],e[0][1][1],t.pos.x+t.hitbox.x+t.hitbox.w-2*this.padding.x),this.checkCollisionDirection(t,1,e[1][0][0],e[1][1][0],t.pos.x+t.hitbox.x,e[1][0][1],e[1][1][1],t.pos.x+t.hitbox.x),this.checkCollisionDirection(t,2,e[2][0][0],e[2][1][0],t.pos.x+t.hitbox.x+2*this.padding.x,e[2][0][1],e[2][1][1],t.pos.x+t.hitbox.x+t.hitbox.w-2*this.padding.x),this.checkCollisionDirection(t,3,e[3][0][0],e[3][1][0],t.pos.x+t.hitbox.x+t.hitbox.w-this.padding.x,e[3][0][1],e[3][1][1],t.pos.x+t.hitbox.x+t.hitbox.w-this.padding.x)}checkCollisionDirection(t,e,i,r,a,o,n,l){const h=this.againstGrid(i,r,a),c=this.againstGrid(o,n,l);t.activeeffects[e]|=h||c?this.type:s.none}}class S extends r.Embodiment{static index=0;static foods={fruit:{apple:{shiny:{x:26,y:15},red:{x:26,y:16},gold:{x:26,y:17},green:{x:26,y:18}},pear:{brown:{x:27,y:15},green:{x:27,y:16},yellow:{x:27,y:17},orange:{x:27,y:18}},citrus:{grapefruit:{brown:{x:28,y:15},yellow:{x:28,y:16},orange:{x:28,y:17}},lemon:{x:29,y:15},lime:{x:29,y:16}},cherries:{red:{x:30,y:15},dark:{x:30,y:16}},melon:{pink:{x:34,y:15},yellow:{x:34,y:16},green:{x:34,y:16}},banana:{x:41,y:15}},veggie:{carrot:{orange:{x:31,y:15},gray:{x:31,y:16},yellow:{x:31,y:17}},radish:{x:32,y:15},turnip:{beet:{x:33,y:15},bad:{x:33,y:16},good:{x:33,y:17}},pepper:{red:{x:35,y:15},yellow:{x:35,y:16},green:{x:35,y:17},dark:{x:35,y:18}},brocolli:{green:{x:36,y:15},brown:{x:37,y:16}},cauliflower:{x:37,y:15},bellpepper:{red:{x:38,y:15},yellow:{x:38,y:16},green:{x:38,y:17}},cucumber:{green:{x:39,y:15},yellow:{x:39,y:16},white:{x:39,y:17}},mushroom:{white:{x:40,y:15},brown:{x:40,y:16}}},sandwich:{bread:{tomato:{x:26,y:19},cheese:{x:26,y:20}},burger:{tomato:{x:27,y:19},cheese:{x:27,y:20},chicken:{x:27,y:21}},hotdog:{ketchup:{x:28,y:19},meat:{x:28,y:20},mustard:{x:28,y:21}}},meat:{chicken:{x:29,y:19},beef:{x:29,y:19},pork:{x:29,y:19}},prepared:{can:{x:30,y:19},catfood:{x:30,y:20},dogfood:{x:30,y:21},ramen:{green:{x:31,y:19},red:{x:31,y:20},yellow:{x:31,y:21}}},cheese:{swiss:{x:32,y:19},brie:{x:32,y:20}},sweets:{icecream:{vanilla:{x:26,y:22},strawberry:{x:26,y:23},chocolate:{x:26,y:24}},lollipop:{strawberry:{x:27,y:22},lemon:{x:27,y:23},greenapple:{x:27,y:24}},candy:{blueberry:{x:28,y:22},gray:{x:28,y:23},toffee:{x:28,y:24}},chocolate:{milk:{x:29,y:22},white:{x:29,y:23},dark:{x:29,y:24}},rizzle:{black:{x:30,y:22},red:{x:30,y:23},blue:{x:30,y:24}}},drinks:{soda:{red:{x:26,y:25},blue:{x:26,y:26},yellow:{x:26,y:27},green:{x:26,y:28}},tea:{white:{x:27,y:25},brown:{x:27,y:26},blue:{x:27,y:27},green:{x:27,y:28}},coffee:{white:{x:28,y:25},brown:{x:28,y:26},red:{x:28,y:27},blue:{x:28,y:28}},wine:{white:{x:29,y:25},rose:{x:29,y:26},red:{x:29,y:27},dark:{x:29,y:28}},champagne:{white:{x:30,y:25},yellow:{x:30,y:26},rose:{x:30,y:27},red:{x:30,y:28}},martini:{x:31,y:25},absynthe:{x:31,y:26},orangedrink:{x:31,y:27},umbrellabrink:{x:31,y:28},beer:{white:{x:32,y:25},brown:{x:32,y:26},red:{x:32,y:27},dark:{x:32,y:28}},cup:{white:{x:33,y:25},brown:{x:33,y:26},red:{x:33,y:27}}}};static heals={palegray:{potions:{small:{x:26,y:33},medium:{x:26,y:34},big:{x:26,y:35},huge:{x:26,y:36}},orbs:{small:{x:26,y:37},medium:{x:26,y:38},big:{x:26,y:39},huge:{x:26,y:40}}},darkgray:{potions:{small:{x:27,y:33},medium:{x:27,y:34},big:{x:27,y:35},huge:{x:27,y:36}},orbs:{small:{x:27,y:37},medium:{x:27,y:38},big:{x:27,y:39},huge:{x:27,y:40}}},black:{potions:{small:{x:28,y:33},medium:{x:28,y:34},big:{x:28,y:35},huge:{x:28,y:36}},orbs:{small:{x:28,y:37},medium:{x:28,y:38},big:{x:28,y:39},huge:{x:28,y:40}}},pink:{potions:{small:{x:29,y:33},medium:{x:29,y:34},big:{x:29,y:35},huge:{x:29,y:36}},orbs:{small:{x:29,y:37},medium:{x:29,y:38},big:{x:29,y:39},huge:{x:29,y:40}}},red:{potions:{small:{x:30,y:33},medium:{x:30,y:34},big:{x:30,y:35},huge:{x:30,y:36}},orbs:{small:{x:30,y:37},medium:{x:30,y:38},big:{x:30,y:39},huge:{x:30,y:40}}},blood:{potions:{small:{x:31,y:33},medium:{x:31,y:34},big:{x:31,y:35},huge:{x:31,y:36}},orbs:{small:{x:31,y:37},medium:{x:31,y:38},big:{x:31,y:39},huge:{x:31,y:40}}},orange:{potions:{small:{x:32,y:33},medium:{x:32,y:34},big:{x:32,y:35},huge:{x:32,y:36}},orbs:{small:{x:32,y:37},medium:{x:32,y:38},big:{x:32,y:39},huge:{x:32,y:40}}},ocre:{potions:{small:{x:33,y:33},medium:{x:33,y:34},big:{x:33,y:35},huge:{x:33,y:36}},orbs:{small:{x:33,y:37},medium:{x:33,y:38},big:{x:33,y:39},huge:{x:33,y:40}}},brown:{potions:{small:{x:34,y:33},medium:{x:34,y:34},big:{x:34,y:35},huge:{x:34,y:36}},orbs:{small:{x:34,y:37},medium:{x:34,y:38},big:{x:34,y:39},huge:{x:34,y:40}}},chartreuse:{potions:{small:{x:35,y:33},medium:{x:35,y:34},big:{x:35,y:35},huge:{x:35,y:36}},orbs:{small:{x:35,y:37},medium:{x:35,y:38},big:{x:35,y:39},huge:{x:35,y:40}}},green:{potions:{small:{x:36,y:33},medium:{x:36,y:34},big:{x:36,y:35},huge:{x:36,y:36}},orbs:{small:{x:36,y:37},medium:{x:36,y:38},big:{x:36,y:39},huge:{x:36,y:40}}},forest:{potions:{small:{x:37,y:33},medium:{x:37,y:34},big:{x:37,y:35},huge:{x:37,y:36}},orbs:{small:{x:37,y:37},medium:{x:37,y:38},big:{x:37,y:39},huge:{x:37,y:40}}},babyblue:{potions:{small:{x:38,y:33},medium:{x:38,y:34},big:{x:38,y:35},huge:{x:38,y:36}},orbs:{small:{x:38,y:37},medium:{x:38,y:38},big:{x:38,y:39},huge:{x:38,y:40}}},blue:{potions:{small:{x:39,y:33},medium:{x:39,y:34},big:{x:39,y:35},huge:{x:39,y:36}},orbs:{small:{x:39,y:37},medium:{x:39,y:38},big:{x:39,y:39},huge:{x:39,y:40}}},navy:{potions:{small:{x:40,y:33},medium:{x:40,y:34},big:{x:40,y:35},huge:{x:40,y:36}},orbs:{small:{x:40,y:37},medium:{x:40,y:38},big:{x:40,y:39},huge:{x:40,y:40}}},white:{potions:{small:{x:41,y:33},medium:{x:41,y:34},big:{x:41,y:35},huge:{x:41,y:36}},orbs:{small:{x:41,y:37},medium:{x:41,y:38},big:{x:41,y:39},huge:{x:41,y:40}}},antiquewhite:{potions:{small:{x:42,y:33},medium:{x:42,y:34},big:{x:42,y:35},huge:{x:42,y:36}},orbs:{small:{x:42,y:37},medium:{x:42,y:38},big:{x:42,y:39},huge:{x:42,y:40}}},skull:{orbs:{small:{x:43,y:33},medium:{x:43,y:34},big:{x:43,y:35},huge:{x:43,y:36}}}};static explosizes={bomb:{1:{x:26,y:41},2:{x:27,y:41},3:{x:28,y:41}},tnt:{1:{x:29,y:41},2:{x:30,y:41},3:{x:31,y:41}}};static light={candle:{x:26,y:42},match:{x:27,y:42},lamp:{x:28,y:42},flashlight:{x:29,y:42}};static chests={firstaid:{closed:{white:{x:29,y:43},blue:{x:30,y:43},orange:{x:31,y:43}},open:{white:{x:29,y:44},blue:{x:30,y:44},orange:{x:31,y:44}}},treasure:{closed:{wood:{x:26,y:43},iron:{x:27,y:43},gold:{x:28,y:43}},open:{wood:{x:26,y:44},iron:{x:27,y:44},gold:{x:28,y:44}}}};static locks={keyhole:{gold:{x:26,y:46},iron:{x:27,y:46},rust:{x:28,y:46}},key:{gold:{x:26,y:45},iron:{x:27,y:45},rust:{x:28,y:45}}};static relics={coin:{iron:{x:26,y:47},bronze:{x:27,y:47},silver:{x:28,y:47},gold:{x:29,y:47},platinum:{x:30,y:47}},coins:{iron:{x:26,y:48},bronze:{x:27,y:48},silver:{x:28,y:48},gold:{x:29,y:48},platinum:{x:30,y:48}},bullion:{iron:{x:26,y:50},bronze:{x:27,y:50},silver:{x:28,y:50},gold:{x:29,y:50},platinum:{x:30,y:50}},cross:{iron:{x:26,y:51},bronze:{x:27,y:51},silver:{x:28,y:51},gold:{x:29,y:51},platinum:{x:30,y:51}},orb:{obsidian:{x:31,y:48},emerald:{x:32,y:48},sapphire:{x:33,y:48},ruby:{x:34,y:48},quartz:{x:35,y:48}},square:{obsidian:{x:31,y:49},emerald:{x:32,y:49},sapphire:{x:33,y:49},ruby:{x:34,y:49},quartz:{x:35,y:49}},rupee:{obsidian:{x:31,y:50},emerald:{x:32,y:50},sapphire:{x:33,y:50},ruby:{x:34,y:50},quartz:{x:35,y:50}},diamond:{obsidian:{x:31,y:51},emerald:{x:32,y:51},sapphire:{x:33,y:51},ruby:{x:34,y:51},quartz:{x:35,y:51}},ore:{iron:{x:26,y:49},bronze:{x:27,y:49},silver:{x:28,y:49},gold:{x:29,y:49},platinum:{x:30,y:49},obsidian:{x:31,y:47},emerald:{x:32,y:47},sapphire:{x:33,y:47},ruby:{x:34,y:47},quartz:{x:35,y:47}},idol:{iron:{x:26,y:52},bronze:{x:27,y:52},silver:{x:28,y:52},gold:{x:29,y:52},platinum:{x:30,y:52},obsidian:{x:31,y:52},emerald:{x:32,y:52},sapphire:{x:33,y:52},ruby:{x:34,y:52},quartz:{x:35,y:52}},skull:{iron:{x:26,y:53},bronze:{x:27,y:53},silver:{x:28,y:53},gold:{x:29,y:53},platinum:{x:30,y:53},obsidian:{x:31,y:53},emerald:{x:32,y:53},sapphire:{x:33,y:53},ruby:{x:34,y:53},quartz:{x:35,y:53},skull:{x:36,y:53}}};constructor(t,e){let s=new a.Snap([new a.Image("_assets/demon/tileset_16x16_5A5268.png",{x:16*t.x,y:16*t.y,w:16,h:16},{x:0,y:0,w:16,h:16})]);super(new a.Frame([s])),this.pos.x=e.x,this.pos.y=e.y}}class F extends b{hitbox;owner;call;constructor(t,e,s,i,r,a){super(t,e,s),this.owner=i,this.hitbox=r,this.call=a}intersect(t){let e=this.owner.pos.x+this.hitbox.x,s=this.owner.pos.y+this.hitbox.y,i=this.hitbox.w,r=this.hitbox.h,a=t.pos.x+t.hitbox.x,o=t.pos.y+t.hitbox.y,n=t.hitbox.w,l=t.hitbox.h;e<a+n&&e+i>a&&s<o+l&&s+r>o&&(this.deleteMe=this.call(this.owner,t))}}class I extends S{static index=2680;constructor(t){super(S.relics.skull.skull,t),this.hitbox={x:0,y:0,w:16,h:16},w.collisionpool.push(new T(this,i.npc,i.player,s.block)),w.collisionpool.push(new F(i.interactable,i.player,s.interact,this,{x:0,y:0,w:16,h:16},this.hurt))}hurt(t,e){return e.react("becomeghost",[]),!1}}class R extends S{static index=2326;myCollision;constructor(t){super(S.locks.keyhole.gold,t),this.hitbox={x:0,y:0,w:16,h:16},this.myCollision=new T(this,i.npc,i.player,s.block),w.collisionpool.push(this.myCollision),w.collisionpool.push(new F(i.interactable,i.player,s.interact,this,{x:0,y:0,w:16,h:16},this.usekey))}usekey(t,e){return e.react("usekey",[t])}}class M extends S{static index=2276;constructor(t){super(S.locks.key.gold,t),w.collisionpool.push(new F(i.interactable,i.player,s.interact,this,{x:0,y:0,w:16,h:16},this.get))}get(t,e){return d.playSound("_assets/demon/key.wav"),e.react("getkey",[1]),t.destroy(),!0}}class C extends S{static index=2635;constructor(t){super(S.relics.idol.silver,t),w.collisionpool.push(new F(i.interactable,i.player,s.interact,this,{x:0,y:0,w:16,h:16},this.grab))}grab(t,e){return d.playSound("_assets/demon/finish.mp3"),e.react("stoptimer",[1]),t.destroy(),!0}}class L extends S{static index=791;constructor(t){super(S.foods.fruit.banana,t),w.collisionpool.push(new F(i.interactable,i.player,s.interact,this,{x:0,y:0,w:16,h:16},this.grab))}grab(t,e){return d.playSound("_assets/demon/grab.wav"),e.react("healthup",[1]),t.destroy(),!0}}!function(t){t[t.stay=0]="stay",t[t.wander=1]="wander",t[t.panic=2]="panic",t[t.rush=3]="rush"}(h||(h={})),function(t){t[t.left=1]="left",t[t.right=3]="right"}(c||(c={}));class D extends n.Fauna{allstates=(1<<n.AniSt.count)-1^1<<n.AniSt.climb;static index=540;dir;jumpgravity={strength:.1,x:0,y:-1};actiontimeouts=[new e.Timeout([200],"stay"),new e.Timeout([300],"wander"),new e.Timeout([1/0],"panic"),new e.Timeout([400],"rush")];awarenessbounds={x:-30,y:-20,w:90,h:75};constructor(t){new o.ScorpionAnimations;let e=o.ScorpionAnimations.fullscorpions[o.ScorpionAnimations.scorpions.green];super(new a.Frame([e[n.AniSt.idle]]));for(let t=0;t<this.actiontimeouts.length;t++)this.timeouts.push(this.actiontimeouts[t]),this.actiontimeouts[t].pause();this.actiontimeouts[h.stay].restart(),this.anims=e,this.pos.x=t.x,this.pos.y=t.y,this.gravity.add(this.normalgravity),this.speed=.075,this.hitbox={x:0,y:0,w:16,h:16},w.collisionpool.push(new T(this,i.npc,i.grid|i.player,s.block)),w.collisionpool.push(new F(i.interactable,i.player,s.interact,this,this.awarenessbounds,this.panic))}panic(t,e){return t.actiontimeouts[h.panic].getTimeoutTicks()>3e3&&(t.pos.x>e.pos.y?t.dir=c.left:t.dir=c.right,t.actiontimeouts[h.panic].restart(),t.gravity.add(t.jumpgravity)),!1}update(){super.update(),this.handleTriggers()}handleTriggers(){for(;this.triggers.length>0;){let t=this.triggers.pop()||{name:"notrigger"};switch(t.name){case"stay":"triggered"===t.state&&100*Math.random()<30&&(this.actiontimeouts[h.stay].pause(),this.actiontimeouts[h.wander].restart(),100*Math.random()<50?(this.flip.flipx=!0,this.dir=c.left):(this.flip.flipx=!1,this.dir=c.right));break;case"wander":switch(t.state){case"triggered":100*Math.random()<90&&(this.actiontimeouts[h.wander].pause(),this.actiontimeouts[h.stay].restart());break;case"active":this.actiontimeouts[h.panic].paused&&(this.movementvector.x=this.dir==c.left?-1:1)}break;case"panic":switch(t.state){case"triggered":case"paused":break;case"active":this.dir==c.left?this.movementvector.x=1:this.movementvector.x=-1,this.actiontimeouts[h.panic].getTimeoutTicks()>=200&&this.gravity.delete(this.jumpgravity),this.actiontimeouts[h.panic].getTimeoutTicks()>=500&&(this.actiontimeouts[h.panic].pause(),this.actiontimeouts[h.stay].restart())}}}}}class B{async start(){}static pool=[];constructor(){B.pool.push(this)}}!function(t){t[t.idle=0]="idle",t[t.pan=1]="pan",t[t.zoom=2]="zoom"}(x||(x={}));class U extends f{action=x.idle;actor;callback=()=>{};pan=[];constructor(){super(!0),this.actor=new r.Embodiment(new a.Frame([new a.Snap([new a.Image("_assets/blocking.png",{x:0,y:0,w:1,h:1},{x:0,y:0,w:1,h:1})])])),this.actor.myFrame.rprops.hidden=!0}refresh(){if(this.action!=x.idle&&this.action==x.pan)for(;this.actor.triggers.length>0;){let t=this.actor.triggers.pop()||{name:""};"pan"==t.name&&("active"==t.state&&(this.actor.pos.x=this.pan[0].x+this.actor.timeouts[0].getTimeoutTicks()/this.actor.timeouts[0].ms[0]*this.pan[1].x,this.actor.pos.y=this.pan[0].y+this.actor.timeouts[0].getTimeoutTicks()/this.actor.timeouts[0].ms[0]*this.pan[1].y),"triggered"==t.state&&(this.actor.timeouts=[],this.action=x.idle,this.callback()))}}panCamera(t,s,i,r=()=>{}){this.actor.pos.x=t.x,this.actor.pos.y=t.y,this.actor.timeouts=[new e.Timeout([i],"pan")],this.pan[0]=t,this.pan[1]={x:s.x-t.x,y:s.y-t.y},this.action=x.pan,this.callback=r}}class P extends B{bodies=[];cellbuild;player;ui=[];paused=!1;uielt;async start(){t.Info.gl.clearColor(0,0,0,1),e.Delta.refresh(),new m,new g,new w,new o.CharacterAnimations,await Promise.all(await d.loadAllExtInFolder("_assets/demon/",["png"])),this.paused=!0;let r=new U,n=new E(r.actor,{w:t.Info.gl.canvas.width,h:t.Info.gl.canvas.height},{x:0,y:0,w:2400,h:320});this.ui.push(r.actor),this.uielt=document.getElementById("instructions"),this.uielt.innerHTML="Attrapez la statuette",this.uielt.style.top="50px",this.uielt.style.fontSize="50px",this.cellbuild=await k.loadIni("_assets/demon/lvl01.ini");let l=v.blit(this.cellbuild,"level-layer"),h=new _(this.cellbuild.collisions,16,i.player|i.npc,s.block);w.collisionpool.push(h),this.putNPCs(this.cellbuild.npcs);let c=new A;return this.player=c,c.uielt=this.uielt,this.bodies.push(c),r.panCamera({x:680,y:200},{x:680,y:200},1e3,()=>{d.playSound("_assets/demon/roar.wav"),r.panCamera({x:680,y:200},{x:680,y:200},2e3,()=>{r.panCamera({x:680,y:200},{x:176,y:200},8e3,()=>{r.panCamera({x:176,y:200},{x:176,y:200},1e3,()=>{this.uielt.innerHTML="",n.actor=c,this.paused=!1})})})}),p.frm=new a.Frame([...l,...this.bodies.map(t=>t.myFrame)]),p.frm.camera=n,c.myCamera=p.frm.camera,p.frm.rprops.srcrect={x:0,y:0,w:t.Info.gl.canvas.width,h:t.Info.gl.canvas.height},p.frm.rprops.shaderID="reverser",new P}run(){e.Delta.refresh(),f.refresh(),this.paused?r.Alacrity.refreshsome(this.ui):r.Alacrity.refresh(),p.frm.camera.refresh(),r.Alacrity.resetallmovements()}putNPCs(t){let e=t.split("\n").map(t=>t.split(","));for(let t=0;t<e.length;t++)for(let s=0;s<e[t].length;s++)switch(Number(e[t][s])){case I.index:this.bodies.push(new I({x:16*s,y:16*t}));break;case R.index:this.bodies.push(new R({x:16*s,y:16*t}));break;case M.index:this.bodies.push(new M({x:16*s,y:16*t}));break;case C.index:this.bodies.push(new C({x:16*s,y:16*t}));break;case L.index:this.bodies.push(new L({x:16*s,y:16*t}));break;case D.index:this.bodies.push(new D({x:16*s,y:16*t}))}}}class z{static iM=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];static ortho(t,e,s,i,r,a){return new Float32Array([i,0,0,0,0,r,0,0,0,0,a,0,t,e,s,1])}static multiplyMatrices(t,e){let s=[e[0],e[1],e[2],e[3]],i=[e[4],e[5],e[6],e[7]],r=[e[8],e[9],e[10],e[11]],a=[e[12],e[13],e[14],e[15]],o=this.multiplyMatrixAndPoint(t,s),n=this.multiplyMatrixAndPoint(t,i),l=this.multiplyMatrixAndPoint(t,r),h=this.multiplyMatrixAndPoint(t,a);return new Float32Array([o[0],o[1],o[2],o[3],n[0],n[1],n[2],n[3],l[0],l[1],l[2],l[3],h[0],h[1],h[2],h[3]])}static multiplyMatrixAndPoint(t,e){let s=t[0],i=t[1],r=t[2],a=t[3],o=t[4],n=t[5],l=t[6],h=t[7],c=t[8],x=t[9],u=t[10],d=t[11],y=t[12],p=t[13],m=t[14],g=t[15],f=e[0],w=e[1],b=e[2],T=e[3];return[f*s+w*o+b*c+T*y,f*i+w*n+b*x+T*p,f*r+w*l+b*u+T*m,f*a+w*h+b*d+T*g]}static rotation(t,e){return this.multiplyMatrices(t,[Math.cos(e),-Math.sin(e),0,0,Math.sin(e),Math.cos(e),0,0,0,0,1,0,0,0,0,1])}static normalize(t,e,s){return t[0]=t[0]/e,t[5]=t[5]/s,t[12]=t[12]/e,t[13]=t[13]/s,t}static orthographic(t,e,s,i,r,a,o=new Float32Array(16)){return o[0]=2/(e-t),o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=2/(i-s),o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[10]=2/(r-a),o[11]=0,o[12]=(t+e)/(t-e),o[13]=(s+i)/(s-i),o[14]=(r+a)/(r-a),o[15]=1,o}static scale(t,e,s,i,r=new Float32Array(16)){return r[0]=e*t[0],r[1]=e*t[1],r[2]=e*t[2],r[3]=e*t[3],r[4]=s*t[4],r[5]=s*t[5],r[6]=s*t[6],r[7]=s*t[7],r[8]=i*t[8],r[9]=i*t[9],r[10]=i*t[10],r[11]=i*t[11],t!==r&&(r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15]),r}static translate(t,e,s,i,r=new Float32Array(16)){var a=t[0],o=t[1],n=t[2],l=t[3],h=t[4],c=t[5],x=t[6],u=t[7],d=t[8],y=t[9],p=t[10],m=t[11],g=t[12],f=t[13],w=t[14],b=t[15];return t!==r&&(r[0]=a,r[1]=o,r[2]=n,r[3]=l,r[4]=h,r[5]=c,r[6]=x,r[7]=u,r[8]=d,r[9]=y,r[10]=p,r[11]=m),r[12]=a*e+h*s+d*i+g,r[13]=o*e+c*s+y*i+f,r[14]=n*e+x*s+p*i+w,r[15]=l*e+u*s+m*i+b,r}}class N extends y{program;name="reverser";matrixLocation;textureMatrixLocation;texture;second=[()=>{}];first=[()=>{let t=y.gl,e=t.getAttribLocation(this.program,"aVertexPosition");t.enableVertexAttribArray(e),t.vertexAttribPointer(e,2,t.FLOAT,!1,0,0);let s=t.getAttribLocation(this.program,"texcoordLocation");t.enableVertexAttribArray(s),t.vertexAttribPointer(s,2,t.FLOAT,!1,0,0),this.matrixLocation=t.getUniformLocation(this.program,"matrixLocation"),this.textureMatrixLocation=t.getUniformLocation(this.program,"textureMatrixLocation"),this.texture=t.getUniformLocation(this.program,"texture")}];passes=[(t,e)=>{let s=y.gl,i=new Float32Array([t.rprops.dstrect.w,0,0,0,0,t.rprops.dstrect.h,0,0,0,0,1,0,t.rprops.dstrect.x,t.rprops.dstrect.y,0,1]);if(i[0]*=2/e.w,i[5]*=-2/e.h,i[12]=i[12]*(2/e.w)-1,i[13]=-i[13]*(2/e.h)+1,s.uniformMatrix4fv(this.matrixLocation,!1,i),null!=this.textureMatrixLocation){let t=z.orthographic(-1,1,1,-1,-1,1);s.uniformMatrix4fv(this.textureMatrixLocation,!1,t)}}]}class X extends y{program;name="normal";matrixLocation;textureMatrixLocation;texture;second=[()=>{}];first=[()=>{let t=y.gl,e=t.getAttribLocation(this.program,"aVertexPosition");t.enableVertexAttribArray(e),t.vertexAttribPointer(e,2,t.FLOAT,!1,0,0);let s=t.getAttribLocation(this.program,"texcoordLocation");t.enableVertexAttribArray(s),t.vertexAttribPointer(s,2,t.FLOAT,!1,0,0),this.matrixLocation=t.getUniformLocation(this.program,"matrixLocation"),this.textureMatrixLocation=t.getUniformLocation(this.program,"textureMatrixLocation")}];passes=[(t,e)=>{let s=y.gl,i=new Float32Array([t.rprops.dstrect.w,0,0,0,0,t.rprops.dstrect.h,0,0,0,0,1,0,t.rprops.dstrect.x,e.h-t.rprops.dstrect.y-t.rprops.dstrect.h,0,1]);if(0!=t.rprops.angle){let e=[];e[0]=Math.cos(-t.rprops.angle)*i[0],e[1]=-Math.sin(-t.rprops.angle)*i[0],e[3]=Math.sin(-t.rprops.angle)*i[5],e[4]=Math.cos(-t.rprops.angle)*i[5],i[0]=e[0],i[1]=e[1],i[4]=e[3],i[5]=e[4]}if(i[0]*=2/e.w,i[1]*=2/e.w,i[4]*=-2/e.h,i[5]*=-2/e.h,i[12]=i[12]*(2/e.w)-1,i[13]=-i[13]*(2/e.h)+1,s.uniformMatrix4fv(this.matrixLocation,!1,i),null!=this.textureMatrixLocation){let e=z.orthographic(-1,1,-1,1,-1,1);e=z.translate(e,0,1,0),t.rprops.flip.flipx&&t.rprops.flip.flipy||(t.rprops.flip.flipx?(e=z.orthographic(1,-1,-1,1,-1,1),e=z.translate(e,-1,1,0)):t.rprops.flip.flipy),s.uniformMatrix4fv(this.textureMatrixLocation,!1,e)}}]}class j extends y{static shaderts=[new X,new N];static async init(){await this.compileAllShadersFrom("shaders/")}static async compileAllShadersFrom(t){let e=[];await Promise.all(await d.loadAllExtInFolder(t,["frag","vert"])).then(t=>{t.map((t,s,i)=>{let r=t.split("/")[1].split(".")[0];for(let t=s;t<i.length;t++)r!=i[t].split("/")[1].split(".")[0]||e.includes(r)||e.push(r)})});for(let t=0;t<e.length;t++)y.shaders[e[t]]=(()=>{let s=y.compileShader(y.gl.VERTEX_SHADER,d.getText("shaders/"+e[t]+".vert")),i=y.compileShader(y.gl.FRAGMENT_SHADER,d.getText("shaders/"+e[t]+".frag")),r=y.createProgram(s,i);r||console.log("Shader creation unsuccessful:"+y.shaders[e[t]]);for(let s=0;s<this.shaderts.length;s++)if(this.shaderts[s].name==e[t]&&null!=r)return this.shaderts[s].program=r,this.shaderts[s];return this.shaderts[0]})();return e}}let O=!0;const q=()=>{O||G.run(),m.refresh(),g.refresh(),p.refresh(),requestAnimationFrame(q)};let G;new t.GL("133","250"),G=new P,(async()=>{await j.init(),await G.start()})().then(()=>{G.run(),document.getElementById("gobutton").style.visibility="visible",q()});let H=document.getElementById("gobutton").getBoundingClientRect();g.addButton("gobutton",{x:H.x,y:H.y,w:H.width,h:500},()=>{d.initAudio(),document.getElementById("gobutton").style.display="none",O=!1})})();